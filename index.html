<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Rkrace-bookmarklet by jacqueminv</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <style>
      #bk {
        display: block;
        height: 3em;
        text-align: center;
        padding: 1.5em 0 0;
        margin: 0 0 1em;
        background-color: #eee;
        border-radius: 1em;
      }

      ins {
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>RKrace-bookmarklet</h1>
        <p>Edit a race map on Runkeeper simply by droping a gpx file.</p>

        <p class="view"><a href="https://github.com/jacqueminv/rkrace-bookmarklet">View the Project on GitHub <small>jacqueminv/rkrace-bookmarklet</small></a></p>

      </header>
      <section>
        <h3>Editing a race map, one click away</h3>

        <p>Being a fan of Runkeeper since a while I was annoyed by their race map creation workflow. You have to provide the race map and this is possible only by manually setting points. This can take minutes if not hours for some races and it can be hard to be precise (e.g. trail races anybody?).</p>

        <p>The little hacker deep inside me kept urging me to have a try fixing this. Here comes my bookmarklet.</p>

        <p>Drag and drop the following link in your bookmarks. Next time you want to edit a race on Runkeeper, simply click this bookmark and a small box asking you to provide a <code>gpx</code> file will appear. Drag and drop the race file and the process will start. This can take a while depending on your browser and available resources as everything is done in the browser. Nothing is sent or tracked from this bookmarklet. The code is open feel free to check.</p>

        <p>Note this was purposed for race maps at first but it actually works for any activity map found on Runkeeper.</p>

        <a id="bk" href="">
          rkrace-bookmarklet
        </a>

        <script>
          function bk(){javascript:(function(){window.type={none:0};var e=document.createElement("div");e.innerText="Drop the gpx race file here.";e.setAttribute("style","font: bold 0.8em Arial; width:13em; padding: 14.5em 0 1em 0; background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIEAAACWCAIAAAB2EXwkAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAFLlJREFUeNrsXQlsHNd5nmtP7kFyeUkiJVq2pZaWLEt1bEFWY6dGmjRpIdSAY8tV3SNJ6/QI4B4obLhxYcMOUDRxggZw0ThIYihJ3SKKauc04qOVlNSBK6uyTlsWFZGSeJjL5bH3zky/2X/59DSzF/dech6Wg+HMm+v/3v/9x5t5TwyHw4JdmlokWwQ2BnaxMbAxsIuNgY2BXWwMbAzsYmNgY2AXVpTlHqDrOpZatujZ0iJPwt8Jvy5JRjsTRVHKFqzQdrbSZhjg2SD6TLakUiksCYlGyrfkLn6LmC09PT24W6wo2dI60q9QD1RVxfNgJRAIAIPm6gFaQDn6Crl3dnaOj4+n02mXy+VwOKAQqNAiYCxbD4BBLBbDY6BxNZ5kSmoGjwrWk9kCDJxO5+Dg4NjYGG7e6/Xi/klF2s8m48nRlKLRKJ6kiQAUIkkCgKwUcSZUdnFxcX5+Htsh9w0bNmC5sLAAYNCYGkOktceAuAjP0CLmN+8uwgDNBW0FGMzNzTGzPDAw4Ha7sQV78SytgMGy7QG1r/JbaAPEbfqXCkSMhhKPxwED3TD5SOAlwDAzMxMOh4PBIDiK+U5tg0FxS9hgIuIB4Ndxh2jjBAO0FuSJLSRoLGVZ7u7uxnJ2dhbbYaUBTBNhaNcYzSR00zoBQN4zrSQSCXasnC1+vz8UCgEe6ArqNKxhtRMGxZXAREEmy0wRDFldgoHHgGBA24eD1NfXh10MhqaYB6lNlcBqEpglYKKn8IXWTY4c7DPB4PF4AAMoC6Yb6tIUGJQ6tdN6C93U/EnWFEJSwyefhyJ5FKszTfYZdWCWAcPU1BR8Vp/Ph3/5lIatB+UaBqtBNmW0wPt5Hj4LAwqCBsAAuQMGaEODfVapfcVtdU81S2G7wPj5n38JBpSuri4sETpQBNcwGKS2EH3JvXx2iImeHYgGbrLJvGEgb5W0Ac4SlpFIBJg1LBumtIXQrWaArTPlYB4RYcCIiEqR5AqpAuMxwIAt0AaoAiw2JfhWFwaFml7evgqrY2qFihp78QQXqQJDDj4rlvPz87Re7wSf0qZcZFIIvpgqkJMDii+erCYMyFNCgQZgCRMNVOAsUSBdJxjaAINyQmXGP3lxgnwhQZgESLbICQkGxmxUGXEDwQBtQIV6wNBa8UERS8D/y3MOLzWrGWB6gCXMbHEMKHDjzQxdCNoA2xAIBBA61AOGNtaDQg5rXsmSHpR2E5cCNyyZl9XR0QFtgLXv7OykBF9tYVDaUehWjSkEA+vHx7LMPg8GA68QsMxQo5mZGcBAzlINYVBWsBKwNyooUVqOHlhh4GMOOFfhcBihHIOhJkhUiEGdclvW1l0oN5fXKlhRYa+0AIPy+/5Y4GayNG63GzCQNtTQWVLaVwOKC5EKI6LyuShv4MYvQUrT09MUzVEEVyUMSltLP68zShJhGDA9KJ+L8gZuPDVBG6ampuAsBYPB6n3WFvJNy+k6zks4JZ0iFNYNvqxiCtx42wBtAAxYBwxwlqqBQWlrzinCQiYigowqwMAauJmWk5OTWOnu7oapWLEYVAAAT0QUGYAuWCcz1pd7TpwErT4SiVDvEPXQQfSObJmdnaWcUsWpPaX1xcr8n+WyOYMBZ8ASYjpz5gy2UA8PZMre9FKzhfjq8uXLbAvTAD7FjYJWDwrq7+8fGhqCKoRCIcRxKyRXUdIxNWUR8mbrTC4m4yJUAINTXz91dlLHJwOAlpSt4y9hOhWwBAaBQAB+EVbo9Rkcu3pzFbzE+VwpvVBEBpnPmDJrQRLncxJ54x5WnyHhdDohfdiAnp4erFTfHJUVJn1TcEDN1kTukDtr+Czc47WNBdhWMwsAwP4IlRGmkRlg9rnRGDTAMS30BpG1Ny3vzZD4mHPJckdW38Z6dQYqrTCTgPOA9yF9YiHmj666GK2IsKjtk0wp0AXvk6SoAjV8/n0LU+RB0uRzISwMJDMAAAADAWDn7PI3fEb99JUHBAerS9gAANpogsGaeaV1qkz+FSQO5kHzxxIRWavkrmtLR8X7igXLy3RCvnw1204eLTEP+aa0wg5nYDBjQApk+oKBoAWQcJZ8Ph+W9J62yQLZemCmJtZ+eXYiVExAMqLPa3XoKHofEs0f/FOndyxWFAZWO0EUxDwlgoG3tCwzyuOXE81SOAYDgObPvx9f22/Z2oCLCnlBheIyZkVpnbcTxE4mIZqiB3ZaAoC6a5gFLtTDsYr0wBoK5IWBWjQBwMRK/1JLZ0lpU1aO8CAjDNtL/MM8qzo9lNK+crdu55NFJGgWADPp8wcyJHioyAaAfCgjXdIAVK8KrctFeR0eq4NU5LV43uU3nY3FVuQ+8RpA2VB6jYU3ACakbb9I4OMyU+vmV/LKnceJURZVoPQqAGDdDw14EKV9hZ7XHlgjZ94xtdpeFhkQNQEAen2okZ8ItvR3OHkpqHjuqMgZ8hoYPiEK6fPm14plEX6z80WClXlY4tOkNPwu3oYT+/PNv2GDKSitowTFQ4QyX6zL+6FOXt+JB8MKgDUQq5/erxybXNwsF4ok+Jch8yYBGQCswkp+57e4gRUsAxMxAKw9aEWas2nd5P/w5iEvHlYAmvmeXePpKK81tjJPoaSm1a7y/ZQ8YCY7XG8HRGlTFuJFZjLLhXJBfLW8ABSxw4X6y5r5zm/jCSovU1lhsHqTVoeS76MvJOhC9LXy44Nyhuwq2Zlspa8yhWg1MNZAweai/BRRRD9KspmVhRo/8GNLf39QTuRcvIWa4rLyVcE66GChJPlK04OST2U1tsWtRTnhrskMsFCg0FE11w+pNemlgvqVpRas/NP4wR7bY+wcodSLF0W+7i8H3eJ+VL0fvG1scpEoupBxLqlV1vC4wda4RbmoTJoq4uCXcx6ec5o+0mzr6kE59FLO51BFzmDyYsuJA1prrISWig8KcVGZprgezsLKscnlaEPFrm2R/p+SkaCtB6WTo+V7tM1q/m1jk4vnG6oUUEmvqdXfq2hYfFDOhZZrCUoeVb8MXVtyUTniKP7qVYvY3va2B+W3yrqyU2th0JTZiOp9xUbyT7v6RfXzEZsbKrdNzq6tNay9fdPVUGwMbAzsUj+bbB3NYyXZD77QgDo04ws/ck/e95cahAGbjGMuoyyKHRnRqYryCm7FG+66H41rwnjy7E8QZF116GmfEAsqmXK+ZatxfMCmgHgn6hlXgxcXhPPzwlxST2urhVgckhB0SRsDrvV+15Ayv6kjXnL4R6XmSgAALiwIr4cDEzHtcnTVkXtSE6YywlRUuDgvDHj9bi2x3p8pPiZtLeMDmn8mmUz+53goJuqXF1aoBSivXF4QHKJwcNz7mRsipAeFYFBqqwQgIpimd8Ka062qmrDKy3RMGE/oEAgNc9QgDMhJWEykXJJL01c7BotJIRlP0jCENIZS3bmIBoYzJntTtbS66hEQBBABRFFypu8a2+TcyHDgoSrG2LMQHCBNampa0DVRkiXFKTpcoihZq+lqOn//AegYR4nsg29Nz6RRf2mvLCqOa05onCwN+eXetLBWKF8gSwMWNggDFovhmmL1009CEJlUJhpxpSO3Dihr/bhVUKr85njs3IzT4euS3T5Rzt2/rmbc6chGT1RL5RlQWRQdRy+rDl83DgGEkO9G96Ins6ClExBwVHOMLgSVjmBOyrj/ZKxHC/e7Uzit5HDHFf/5hHFgBQ+hFhiurY7xQW6cOFy5OotsnCMRdS5e+ezOznt3fcC0d2x67huHzv/w4rwz2EeigScw7Fr8yt6bC51wLpr47v+c//bJSMrbL8pyJhH7yoNb2d59//qLi3GH7PIap8oklfnLz+y7cagnQHv/4PlTmuoVRK0iPSg9OGvt80WkB1k2qvSXUVOLc0PqpQN/evO9uzZZLzHUG/z7e7Y//AFnInwlk06pWc5VU/EidxXscP/x3SNf3jMI+app9WxEfualY2zvn+1ek5idME4F33ouvPcmFwMA1VBZF6QKn6WMjwTqki/Sq7MHWirenbzy7J/sgODYxhOjE3Ox5FBvYH1fF235xB2bxsPHXnhvxuEL4XK6fPVRL06Ex2YWDG7R9YDXueW6Adp+04beh26b/cKbc0pH5/63Ix/eOrVluA/bd40MfezE5I+vRESHc1iZ+dSHd+cuemFq/9tJd2+/Zjh5amWiaE7OzggNKuYiXUtGph/dM8QAOHLy4pPfPzeZ6RAlRUuNfWi98A/3/lrQZ8wu9Fe/c8tPv3hkJuXD5XTOF37h8Nn9J1KKJ5CdUTyxPXT6mQd30iGf2L3p6VcOS55O2d/7xItn//2zfXTIwx/f8tMvvbGYFh/7w83sPKgg+9dpulTx45QTJUl1wkCttKQT0e2hFBomnert0Ym//d75993rHV2DSucaR8+G16d8X3jpOLvW3Tf6Qe7GBfWrTysqLtnXIwf6leCAI7T+6GzHD998j+29dZ0jnUwIsvPdeOCfDv4vI6t92zwPjMhbhvtpC3ahAqqpVRWtOXoAgYiVclEmvnjb5qszaD336rm4q1eWnOzLb8kTPPjuxEdPX4YnKsBrlI1dYtYfuNZT5fhQco7NXE1dwXpoGRyrSJ7AN98a+8i2ya3XGXJ/6Ldvm1uILWE/+c23os7QUMUsxERRRwyKDJJigJ+pUHnT8diuTRvZvy+/G3f1rUUjB0fBVzWcerR3xfvp74zCgYHnLrt8sidgiJXjItRVM5qIe9CzHu5i5KZ1a9jeSNxATTfuUJK8PY9/9+SBv8m1/aDfSyvYKHkHNE0SqnOym6YHxiDoFetBMr51Y86EHjo+qsvZnAdAyKTWOBbXdCSN5o9ijPUtIfha0NR3FpPCtfOyqMloYnpWmp8GBn6Hev+24Md35lj+l5Ozp6ZVZ7eYu0PZeXre/fkXjjxy3x3scPyLjY6AU6060lSbZZO1KjBQ1QwfXAEAegwtGbt7k/x3v3uHqf7hk+Of/LeLksvH68EjD9z5yAP5z/+dw+8JTp/KGEbPjjyuide6BYYqwxsVRL0GohDEhnJRrhMto+mVcpGm8rJASJuRsqeCU6+pUr76iAxSugymKn3Fb7168qtvLCiBfnXp9rRUbFNH/NG9v8lXe3Tv7p89/fI78Zjk9FaLgXEhuTlcpFeqB5oo/d+5y9tuWIv1D27bmHnuhJROwfbqonxiKv30f7xpWIV0fN9vbB1e28OikexfsTb70s/P/ODY5E/eU2UEE1lyIx3IRCae+stbrPWfum/rnn8+pnQNwuRUrQdNwUDTKsZAl5zHL7xPGKB8ZLP35UuLoBpBlH92ST1yEfYgkw6P/cWe25eUD5dTjZwApwdPPv/KvxyekpxL86NIsuRwi64OqcOjwR1Xl1goNvvp24Pbrs+Z6+d/9IsNA113br8R69j4qdtHv3p0RvZ2CWLlHrymNTM+qPAHI/zSWxPsVH/+0ZHU7BUYaiMIk5y64kWdB3YOdfq9VxmLDuT7KxSPFFgndW3I/YKDgrdHlz1G7Lh0IUQVm33Rx/buyjlLi/GnfjD61PdOsXNgFyoYwYdaVeqlXhjoRYuWUSv+6YJyaDT1X8fO04WgEM/u+5WB9KXU+2Pp8KXU1OjO0MJj99/O3YrBucaxfIsreQ+pVHpu8h9/bzs74q+/dmhR6TsR8T6x/xDbiAqohsrVPFHT/CK9Gq/OFXjywCmwQaffCNb27B7B7/Wj5+AmDQ90Dq8JWVKExuV4PchNN1HoHmC+Y5HP7A7dssR4Bw+f+v7phOwPQqf2vzH14N3h4TXd2I4KD+0OPfvzsOTtrIyRypFDy3GR0eEhOo7PuO/5/E8iC1dToXftuOGu7dczAJ759iumy2lcrkIrmrsFs410Jh7f9+s5FlqIPXngjO7qBG3AWkR0/8PPHWGnQrWRYCzLSGpbcVG1IOi64j4+6/3Q53709R8ftV798ecPPfHi6LFzV7JP4NAF2dAB+WqSVZRdui4WPH86+bn7drDKXzr41oWoG34X5ZphkP77gnrwyFlW4YufvMOvVP44JYUphsPhZQSxmczc3NylS5fS6fTIyIg5zZBOx2KxSCTysW/Mi86OqtVJR2ysp6JBKXbX5s4NvYYRnotlDh6dmkeULDv1VEzIJASHR3L5Dec1HdcTC7qaFGUHri46fUIht1JNa8kFIRWDtuSvTBXSMSM1Ikqi4VMFRKOzaNmfKeD+X32ojyaRojlEGmYPNLEmb7aIDsEVnNP8B8+mhNMLhv2VFFHuxdIQh9uVuxz9yR6hwyPm7LThsxZOOMuCqxO/wpWvqZCroy69y7g8e9CsfFFN+pM5KATZZfw4vq9AHE0p5UTvtc9VZAP0tChlhGaPxdECCBh5m5KvXtdYD+h6bjETTycFxbXaMcgkXUJKKPW9m1JzALAc8sZOv58Qfb0VGLEVpQWx8PX9YsnxSWqvB7Is//6tHY8e+KUGT8PdtXohSMyKsek/2rmJBjRvEAZsFoEd13Xdf/Pkt44cF/zrRN+A4HALK/ozEJMnJKQT+uKEsHDpwTuHd2zsbuj3BzSbD80rufeD113f63jxyJnzY8fmYqlVpQDBDtcNazvv+a0tO29aTzNL0dwiDcKApjNBPIK4/rZfHdw6HEqlUnUaDLVFyunTp/v7+7u6uiBuJgSEYx6Px+/30/x2jeYiXJLNfEXTbLMJslZkgZQDgUAwGITQhaUZgl3Zgl1sirsGfYeTy0BlYaDmAAz4N79XpDYAAChBKBSC9gvcNNkQPWCgCR8b55syVWDGmV775iemX3nF5/OBc6AHwIBNG0xzyNNKvb7LLA4Dm18DMFQ29GIbFTR2mliWYdD875N5JFaDF0S0QzPbVXYGe6yEFkCxYoOs6/YXZ7Upy9YDsvtsPmG7lAyDa68HFIDYomeFIoDGYUBKgKvOz8+/9tprMzMz0WgUEcAqFD0aIiKD3t7ewcFBioQbhAGuBMwR/vX09GAFS4TBaq0+g203CkJbRHCAAA0r1ZBzJVyESwIMxMCpVIqisNVoSLPNkfJCWGmcHhAXsTwEJSFWp4PE4tCS3QO11wPbL2q+b2oXGwMbA7vYGNgY2MXGwMbALjYGNgZ2sTGwMbCLjYGNgV3qWv5fgAEAZ3EV/EUnHxMAAAAASUVORK5CYII=') #EAEAEA no-repeat; position: fixed; top: 1em; left: 1em; z-index: 99999; text-align: center;");e.addEventListener("dragover",f,false);e.addEventListener("drop",a,false);document.body.appendChild(e);var h=document.createElement("div"),d=("draggable" in h)||("ondragstart" in h&&"ondrop" in h),c=window.webkitURL.createObjectURL||window.URL.createObjectURL,b=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,g=function(i){e.innerText=i||"";setTimeout(function(){e.parentElement.removeChild(e)},2000)};if(!(d&&c&&b&&Worker&&FileReader)){g("You need a more recent browser");return}if(!window.mapController){g("Either you're not on RK race edition page, or RK made modifications to the code.");return}if(!mapController.model.editable){g("You must edit the race before proceeding.");return}function a(i){i.stopPropagation();i.preventDefault();var l=i.dataTransfer.files,o,n,j;if(l.length!==1||l[0].size&&l[0].size>5242880){alert("Please give only one file (max size accepted: 5mb)");return}function k(r){marknote=function(){};marknote.constants={DOCTYPE_START:"<!DOCTYPE",CDATA_START:"<![CDATA[",CDATA_END:"]]>",COMMENT_START:"<!--",COMMENT_END:"-->",TAG_OPEN:"<",TAG_CLOSE:">",TAG_CLOSE_SELF_TERMINATING:"/>",ENDTAG_OPEN:"</",EQUALS:"=",SQUOTE:"'",DQUOTE:'"',PI_START:"<?",PI_END:"?>",BRACKET_OPEN:"[",BRACKET_CLOSE:"]",TOKENTYPE_BRACKET_OPEN:"bracketOpen",TOKENTYPE_TAG_OPEN:"tagOpen",TOKENTYPE_TAG_CLOSE:"tagClose",TOKENTYPE_ENDTAG_OPEN:"endTagOpen",TOKENTYPE_ENDTAG_CLOSE:"endTagClose",TOKENTYPE_SELF_TERMINATING:"closeTagSelfTerminating",TOKENTYPE_WHITESPACE:"whitespace",TOKENTYPE_ATTRIBUTE:"attribute",TOKENTYPE_QUOTE:"quote",TOKENTYPE_QUOTED:"quotedLiteral",TOKENTYPE_NORMAL:"normal",TOKENTYPE_COMMENT_START:"commentStart",TOKENTYPE_COMMENT_END:"commentEnd",TOKENTYPE_CDATA_START:"cdataStart",TOKENTYPE_CDATA_END:"cdataEnd",TOKENTYPE_PI_START:"piStart",TOKENTYPE_PI_END:"piEnd",TOKENTYPE_DOCTYPE_START:"docTypeStart",DATATYPE_ATTRIBUTE:"marknote.Attribute",DATATYPE_CDATA:"marknote.CDATA",DATATYPE_CLONER:"marknote.Cloner",DATATYPE_COMMENT:"marknote.Comment",DATATYPE_DOCTYPE:"marknote.DOCTYPE",DATATYPE_DOCUMENT:"marknote.Document",DATATYPE_ELEMENT:"marknote.Element",DATATYPE_ENTITYREF:"marknote.EntityRef",DATATYPE_XMLENTITYREFS:"marknote.XMLEntityRefs",DATATYPE_ENTITYREFS:"marknote.EntityRefs",DATATYPE_PARSER:"marknote.Parser",DATATYPE_PROCESSINGINSTRUCTION:"marknote.ProcessingInstruction",DATATYPE_QNAME:"marknote.QName",DATATYPE_TEXT:"marknote.Text",DATATYPE_TOKEN:"marknote.Token",DATATYPE_TOKENIZER:"marknote.Tokenizer",DATATYPE_WRITER:"marknote.Writer"};marknote.SJAX=function(){this.req=null;this.status=null;this.statusText=null;this.responseText=null};marknote.Attribute=function(t,s){this.dataType=marknote.constants.DATATYPE_ATTRIBUTE;this.isSw8tXmlContent=false;this.name=t;this.value=marknote.Util.erefEncode(marknote.Util.nothingToBlank(s))};marknote.Attribute.prototype.getName=function(){return this.name};marknote.Attribute.prototype.setName=function(s){this.name=s};marknote.Attribute.prototype.getValue=function(){return marknote.Util.erefDecode(marknote.Util.nothingToBlank(this.value))};marknote.Attribute.prototype.setValue=function(s){this.value=marknote.Util.erefEncode(marknote.Util.nothingToBlank(s))};marknote.Attribute.prototype.clone=function(){return new marknote.Attribute(this.getName(),this.getValue())};marknote.CDATA=function(s){this.dataType=marknote.constants.DATATYPE_CDATA;this.isSw8tXmlContent=true;this.text=marknote.Util.nothingToBlank(s)};marknote.CDATA.prototype.getText=function(){return marknote.Util.nothingToBlank(this.text)};marknote.CDATA.prototype.setText=function(s){this.text=marknote.Util.nothingToBlank(s)};marknote.CDATA.prototype.clone=function(){var s=new marknote.Cloner();return s.clone(this)};marknote.Cloner=function(){this.dataType=marknote.constants.DATATYPE_CLONER;this.isSw8tXmlContent=false};marknote.Cloner.prototype.cloneDocument=function(v){var x=new marknote.Document();var u=v.getProcessingInstructions();var t=v.getRootElement();var y;for(var w=0;w<u.length;w++){y=this.cloneProcessingInstruction(u[w]);x.addProcessingInstruction(y)}var s=this.cloneElement(t);x.setRootElement(s);return x};marknote.Cloner.prototype.cloneProcessingInstruction=function(u){var s=u.getData();var t=u.getTarget().slice(0);var v=this.cloneArray(s);return new marknote.ProcessingInstruction(t,v)};marknote.Cloner.prototype.cloneElement=function(w){var v=new marknote.Element();var t=w.getName().slice(0);var s=this.cloneArray(w.getAttributes());v.setName(t);v.setAttributes(s);if(w.isSelfTerminated){v.isSelfTerminated=true;return v}var u=this.cloneContents(w);v.setContents(u);return v};marknote.Cloner.prototype.cloneContents=function(w){var v=new Array();var s,t;for(var u=0;u<w.getContents().length;u++){var x=w.getContentAt(u);t=marknote.Util.dataType(x);switch(t){case marknote.constants.DATATYPE_ELEMENT:s=this.cloneElement(x);v.push(s);break;default:s=this.clone(x);v.push(s);break}}return v};marknote.Cloner.prototype.clone=function(u){var t=(u.dataType&&u.dataType.indexOf("marknote.")>0)||typeof u=="object";if(!t){return u}var v=new Object();for(var s in u){v[s]=this.clone(u[s])}return v};marknote.Cloner.prototype.cloneArray=function(v){var s=new Array();var u;for(var t=0;t<v.length;t++){u=this.clone(v[t]);s.push(u)}return s};marknote.Comment=function(s){this.dataType=marknote.constants.DATATYPE_COMMENT;this.isSw8tXmlContent=true;this.text=marknote.Util.erefEncode(marknote.Util.nothingToBlank(s))};marknote.Comment.prototype.getText=function(){return marknote.Util.erefDecode(marknote.Util.nothingToBlank(this.text))};marknote.Comment.prototype.setText=function(s){this.text=marknote.Util.erefEncode(marknote.Util.nothingToBlank(s))};marknote.Comment.prototype.clone=function(){var s=new marknote.Cloner();return s.clone(this)};marknote.FPI=function(w,s,u,t,v){this.registration=w;this.organization=s;this.publicTextClass=u;this.publicTextDescription=t;this.publicTextLanguage=v};marknote.FPI.prototype.getRegistration=function(){return this.registration};marknote.FPI.prototype.setRegistration=function(s){this.registration=s};marknote.FPI.prototype.getOrganization=function(){return this.organization};marknote.FPI.prototype.setOrganization=function(s){this.organziation=s};marknote.FPI.prototype.getPublicTextClass=function(){return this.publicTextClass};marknote.FPI.prototype.setPublicTextClass=function(s){this.publicTextClass=s};marknote.FPI.prototype.getPublicTextDescription=function(){return this.publicTextDescription};marknote.FPI.prototype.setPublicTextDescription=function(s){this.publicTextDescription=s};marknote.FPI.prototype.getPublicTextLanguage=function(){return this.publicTextLanguage};marknote.FPI.prototype.setPublicTextLanguage=function(s){this.publicTextLanguage=s};marknote.DOCTYPE=function(u,x,z,t,y){this.dataType=marknote.constants.DATATYPE_DOCTYPE;this.isSw8tXmlContent=false;if(u&&!x){var w=new String(u);var v=new marknote.Parser();var s=v.parseDOCTYPE(w);this.topElement=s.getTopElement();this.availability=s.getAvailability();this.FPI=s.getFPI();this.URL=s.getURL();this.internalSubset=s.getInternalSubset()}else{this.setTopElement(u);this.setAvailability(x);this.setFPI(z);this.setURL(t);this.setInternalSubset(y)}};marknote.DOCTYPE.prototype.getTopElement=function(){return this.topElement};marknote.DOCTYPE.prototype.setTopElement=function(s){this.topElement=s};marknote.DOCTYPE.prototype.getAvailability=function(){return this.availability};marknote.DOCTYPE.prototype.setAvailability=function(s){this.availability=s};marknote.DOCTYPE.prototype.getFPI=function(){return this.FPI};marknote.DOCTYPE.prototype.setFPI=function(s){this.FPI=s};marknote.DOCTYPE.prototype.getURL=function(){return this.URL};marknote.DOCTYPE.prototype.setURL=function(t){var s=marknote.Util.trim(t);if(s===""){this.URL="";return}if(s.charAt(0)!='"'){s='"'+s}if(s.charAt(s.length-1)!='"'){s+='"'}this.URL=s};marknote.DOCTYPE.prototype.getInternalSubset=function(){return this.internalSubset};marknote.DOCTYPE.prototype.setInternalSubset=function(s){this.dataType=marknote.constants.DATATYPE_DOCTYPE;this.internalSubset=s};marknote.Document=function(){this.dataType=marknote.constants.DATATYPE_DOCUMENT;this.isSw8tXmlContent=false;this.processingInstructions=new Array();this.rootElement=new marknote.Element();this.contents=new Array()};marknote.Document.prototype.getProcessingInstructions=function(){return this.processingInstructions};marknote.Document.prototype.setProcessingInstructions=function(s){this.processingInstructions=s};marknote.Document.prototype.addProcessingInstruction=function(s){this.processingInstructions.push(s)};marknote.Document.prototype.removeProcessingInstruction=function(u){for(var s=0;s<this.processingInstructions.length;s++){var t=this.processingInstructions[s].getTarget();if(t==u){marknote.Util.removeArrayItem(this.processingInstructions,s)}}};marknote.Document.prototype.getRootElement=function(){return this.rootElement};marknote.Document.prototype.setRootElement=function(s){if(!(s instanceof marknote.Element)){return}this.rootElement=s};marknote.Document.prototype.getDOCTYPE=function(){return this.DOCTYPE};marknote.Document.prototype.setDOCTYPE=function(s){this.DOCTYPE=s};marknote.Document.prototype.getBaseURI=function(){return this.baseURI};marknote.Document.prototype.setBaseURI=function(s){this.baseURI=s};marknote.Document.prototype.clone=function(){var s=new marknote.Cloner();return s.cloneDocument(this)};marknote.Element=function(s){this.dataType=marknote.constants.DATATYPE_ELEMENT;this.isSw8tXmlContent=true;this.contents=new Array();this.attributes=new Array();this.qname=new marknote.QName();this.isSelfTerminated=false;if(s){if(s instanceof marknote.QName){this.setQName(s)}else{this.setName(s)}}};marknote.Element.prototype.getName=function(){return this.qname.getName()};marknote.Element.prototype.setName=function(s){this.qname.setName(s)};marknote.Element.prototype.getQName=function(){return this.qname};marknote.Element.prototype.setQName=function(s){this.qname=s};marknote.Element.prototype.hasContents=function(){return this.contents&&this.contents.length>0};marknote.Element.prototype.getContents=function(){return this.contents};marknote.Element.prototype.getContentAt=function(s){return this.getContents()[s]};marknote.Element.prototype.addContent=function(s){if(s&&s.isSw8tXmlContent){this.getContents().push(s)}};marknote.Element.prototype.removeContent=function(s){marknote.Util.removeArrayItem(this.contents,s)};marknote.Element.prototype.setContents=function(s){this.contents=s};marknote.Element.prototype.getText=function(v){var u="";if(typeof v=="undefined"){v=true}for(var s=0;s<this.contents.length;s++){var w=this.getContentAt(s);var t=marknote.Util.dataType(w);if(t==marknote.constants.DATATYPE_TEXT){u+=w.getText(v)}else{if(t==marknote.constants.DATATYPE_CDATA){u+=w.getText()}}}return u};marknote.Element.prototype.setText=function(u){var t=new Array();for(var w=0;w<this.contents.length;w++){var v=this.getContentAt(w);var s=marknote.Util.dataType(v);if(s==marknote.constants.DATATYPE_COMMENT){t.push(v)}}this.contents=t;u=u?""+u:"";this.contents.push(new marknote.Text(u))};marknote.Element.prototype.setCDATAText=function(u){var t=new Array();for(var w=0;w<this.contents.length;w++){var v=this.getContentAt(w);var s=marknote.Util.dataType(v);if(s==marknote.constants.DATATYPE_COMMENT){t.push(v)}}this.contents=t;u=u?""+u:"";this.contents.push(new marknote.CDATA(u))};marknote.Element.prototype.removeText=function(){for(var s=this.contents.length-1;s>=0;s--){var u=this.getContentAt(s);var t=marknote.Util.dataType(u);if(t==marknote.constants.DATATYPE_TEXT||t==marknote.constants.DATATYPE_CDATA){marknote.Util.removeArrayItem(this.contents,s)}}};marknote.Element.prototype.getCommentText=function(){var u="";for(var s=0;s<this.contents.length;s++){var v=this.getContentAt(s);var t=marknote.Util.dataType(v);if(t==marknote.constants.DATATYPE_COMMENT){u+=v.getText()}}return u};marknote.Element.prototype.setCommentText=function(s){this.removeComments();s=s?""+s:"";this.addContent(new marknote.Comment(s))};marknote.Element.prototype.removeComments=function(){for(var s=this.contents.length-1;s>=0;s--){var u=this.getContentAt(s);var t=marknote.Util.dataType(u);if(t==marknote.constants.DATATYPE_COMMENT){marknote.Util.removeArrayItem(this.contents,s)}}};marknote.Element.prototype.addChildElement=function(s){var t=marknote.Util.dataType(s);if(!t==marknote.constants.DATATYPE_ELEMENT){return}this.getContents().push(s)};marknote.Element.prototype.removeChildElements=function(u){var v=0;if(!u){v=this.contents.length;this.contents=new Array();return v}var x=u.dataType==marknote.constants.DATATYPE_QNAME?u.getName():u;var w=marknote.Cloner.cloneArray(this.contents);for(var s=w.length-1;s>=0;s--){var t=marknote.Util.dataType(w[s]);if(t!=marknote.constants.DATATYPE_ELEMENT){continue}if(this.clonedContents[s].getName()==x){marknote.Util.removeArrayItem(this.contents,s);v++}}return v};marknote.Element.prototype.getChildElements=function(v){var x=false;var u=new Array();if(v){x=v.dataType==marknote.constants.DATATYPE_QNAME?v.getName():v}for(var s=0;s<this.contents.length;s++){var w=this.contents[s];var t=marknote.Util.dataType(w);if(t!=marknote.constants.DATATYPE_ELEMENT){continue}if(x){if(w.getName()==x){u.push(w)}}else{u.push(w)}}return u};marknote.Element.prototype.getChildElement=function(y){var s=y.dataType==marknote.constants.DATATYPE_QNAME?y.getName():y;if(s){var u=this.getContents();for(var v=0;v<u.length;v++){var w=u[v];var t=marknote.Util.dataType(w);if(t==marknote.constants.DATATYPE_ELEMENT){var x=w.getName();if(x===s){return w}}}}};marknote.Element.prototype.removeChildElement=function(y){var s=y.dataType==marknote.constants.DATATYPE_QNAME?y.getName():y;if(s){var u=this.getContents();for(var v=0;v<u.length;v++){var w=u[v];var t=marknote.Util.dataType(w);if(t==marknote.constants.DATATYPE_ELEMENT){var x=w.getName();if(x===s){marknote.Util.removeArrayItem(this.contents,v);return}}}}};marknote.Element.prototype.getAttributes=function(){return this.attributes};marknote.Element.prototype.setAttributes=function(s){this.attributes=s};marknote.Element.prototype.getAttribute=function(t){for(var s=0;s<this.getAttributes().length;s++){var u=this.getAttributes()[s];if(u.getName()==t){return u}}};marknote.Element.prototype.getAttributeValue=function(t){var s=this.getAttribute(t);return s?s.getValue():""};marknote.Element.prototype.getAttributeAt=function(s){return this.getAttributes()[s]};marknote.Element.prototype.setAttribute=function(t,u){if(marknote.Util.dataType(t)==marknote.constants.DATATYPE_ATTRIBUTE){this.putAttribute(t)}else{for(var s=0;s<this.getAttributes().length;s++){var v=this.getAttributes()[s];if(v.getName()==t){v.setValue(u);return}}this.putAttribute(new marknote.Attribute(t,u))}};marknote.Element.prototype.putAttribute=function(s){if(s&&this.getAttribute(s.getName())){this.removeAttribute(s.getName())}this.getAttributes().push(s)};marknote.Element.prototype.removeAttribute=function(t){var u=new Array();for(var s=0;s<this.getAttributes().length;s++){var v=this.getAttributes()[s];if(v.getName()!=t){u.push(v)}}this.setAttributes(u)};marknote.Element.prototype.removeAllAttributes=function(){this.setAttributes(new Array())};marknote.Element.prototype.clone=function(){var s=new marknote.Cloner();return s.cloneElement(this)};marknote.EntityRef=function(t,s){this.dataType=marknote.constants.DATATYPE_ENTITYREF;this.name=t;this.character=s};marknote.EntityRef.prototype.getName=function(){return this.name};marknote.EntityRef.prototype.setName=function(s){this.name=s};marknote.EntityRef.prototype.getName=function(){return this.name};marknote.EntityRef.prototype.setName=function(s){this.dataType=marknote.constants.DATATYPE_ENTITYREF;this.isSw8tXmlContent=false;this.character=s};marknote.EntityRef.prototype.clone=function(){var s=new marknote.Cloner();return s.clone(this)};marknote.XMLEntityRefs=function(){this.dataType=marknote.constants.DATATYPE_XMLENTITYREFS;this.isSw8tXmlContent=false;this.refs=new Array();this.pushRef("quot",34);this.pushRef("amp",38);this.pushRef("apos",39);this.pushRef("lt",60);this.pushRef("gt",62)};marknote.XMLEntityRefs.prototype.getRefs=function(){return this.refs};marknote.XMLEntityRefs.prototype.pushRef=function(s,t){this.refs.push(new marknote.EntityRef(s,String.fromCharCode(t)))};marknote.EntityRefs=function(){this.dataType=marknote.constants.DATATYPE_ENTITYREFS;this.isSw8tXmlContent=false;this.refs=new Array().concat(new marknote.XMLEntityRefs().getRefs())};marknote.EntityRefs.prototype.getRefs=function(){return this.refs};marknote.Parser=function(){this.dataType=marknote.constants.DATATYPE_PARSER;this.isSw8tXmlContent=false;this.doc=new marknote.Document();this.status=0;this.statusMessage="success"};marknote.Parser.prototype.getDocument=function(){return this.doc};marknote.Parser.prototype.getStatus=function(){return this.status};marknote.Parser.prototype.setStatus=function(s){this.status=s};marknote.Parser.prototype.getStatusMessage=function(){return this.statusMessage};marknote.Parser.prototype.setStatusMessage=function(s){this.statusMessage=s};marknote.Parser.prototype.parseProcessingInstructions=function(y,v){var t=new marknote.Tokenizer(y);var x=t.tokenize();var C=0,G=0;var H=false;var B,z,D,A,I,w,u;for(var s=0;s<x.length;s++){u=x[s].getType();switch(u){case marknote.constants.TOKENTYPE_PI_START:C=x[s].getPosition();z="";D=new Array();H=true;z=x[s+1].getContent();s++;break;case marknote.constants.TOKENTYPE_PI_END:if(H){if(marknote.Util.isUndefinedNullOrBlank(z)){z="xml"}}H=false;G=x[s].getPosition()+2;B=new marknote.ProcessingInstruction(z,D);v.addProcessingInstruction(B);break;case marknote.constants.TOKENTYPE_ATTRIBUTE:if(H){I=x[s-1].getContent();w=x[s+1].getContent();w=w.slice(1,w.length-1);A=new marknote.Attribute(I,w);D.push(A)}s++;break;default:break}}if(G>C){var E=C>0?y.slice(0,C):"";var F=y.slice(G+1);return marknote.Util.trim(E+F)}else{return y}};marknote.Parser.prototype.parseProcessingInstructions=function(y,v){var t=new marknote.Tokenizer(y);var x=t.tokenize();var C=0,G=0;var H=false;var B,z,D,A,I,w,u;for(var s=0;s<x.length;s++){u=x[s].getType();switch(u){case marknote.constants.TOKENTYPE_PI_START:C=x[s].getPosition();z="";D=new Array();H=true;z=x[s+1].getContent();s++;break;case marknote.constants.TOKENTYPE_PI_END:if(H){if(marknote.Util.isUndefinedNullOrBlank(z)){z="xml"}}H=false;G=x[s].getPosition()+2;B=new marknote.ProcessingInstruction(z,D);v.addProcessingInstruction(B);break;case marknote.constants.TOKENTYPE_ATTRIBUTE:if(H){I=x[s-1].getContent();w=x[s+1].getContent();w=w.slice(1,w.length-1);A=new marknote.Attribute(I,w);D.push(A)}s++;break;default:break}}if(G>C){var E=C>0?y.slice(0,C):"";var F=y.slice(G+1);return marknote.Util.trim(E+F)}else{return y}};marknote.Parser.prototype.parseDOCTYPE=function(x,v){var t=new marknote.Tokenizer(x);var w=t.tokenize();var y=new marknote.DOCTYPE();var u,z;try{for(var s=0;s<w.length;s++){u=w[s].getType();switch(u){case marknote.constants.TOKENTYPE_DOCTYPE_START:if(v){v.setDOCTYPE(y)}if(w[++s].isTagClose()){return y}y.setTopElement(w[s].getContent());z=w[++s].getContent().toUpperCase();y.setAvailability(z);if("SYSTEM"==z){if(w[++s].isTagClose()){return y}y.setURL(w[s].getContent())}else{if("PUBLIC"==z){if(w[++s].isTagClose()){return y}y.setFPI(w[s].getContent());if(w[++s].isTagClose()){return y}y.setURL(w[s].getContent());if(w[++s].isTagClose()){return y}y.setInternalSubset(w[s].getContent())}}break;case marknote.constants.TOKENTYPE_TAG_CLOSE:return y;default:break}}}catch(A){window.alert(A)}return y};marknote.Parser.prototype.parse=function(s){this.xhr=null;this.xhrStatus=null;this.xhrStatusText=null;this.xhrResponseText=null;this.doc=new marknote.Document();this.setStatus(0);s=this.parseProcessingInstructions(s,this.doc);this.parseDOCTYPE(s,this.doc);this.parseElement(s,this.doc);return this.doc};marknote.Parser.prototype.parseURL=function(t,v,u){var w=new marknote.SJAX();var s=w.read(t,v,u);this.xhr=w.getRequest();this.xhrStatus=w.getStatus();this.xhrStatusText=w.getStatusText();this.xhrResponseText=w.getResponseText();return s};marknote.Parser.prototype.parseComment=function(t,w,s){var v=w[s+1].content==marknote.constants.COMMENT_START?"":w[s+1].content;var u=new marknote.Comment(v);if(t){t.addContent(u)}s=w[s+1].content==marknote.constants.COMMENT_START?s+1:s+2;return s};marknote.Parser.prototype.parseElement=function(A,t,G){var F=new marknote.Tokenizer(A);var I=F.tokenize();var y=0,P=0;var C=false;for(var K=0;K<I.length;K++){if(I[K].isCommentStart()){K=this.parseComment(G,I,K);continue}for(;K<I.length;K++){if(I[K].isTagOpen()){y=K;break}}if(y!=K){return}var z=new marknote.Element(I[y+1].content);if(!G){t.setRootElement(z)}else{G.addContent(z)}for(K=y+1;K<I.length;K++){switch(I[K].getType()){case marknote.constants.TOKENTYPE_SELF_TERMINATING:z.isSelfTerminated=true;y=K;break;case marknote.constants.TOKENTYPE_TAG_CLOSE:z.isSelfTerminated=false;y=K;break;case marknote.constants.TOKENTYPE_ATTRIBUTE:try{var S=I[K-1].content;var N=I[K+1].content;var H=N.slice(1,N.length-1);var L=new marknote.Attribute(S,H);z.putAttribute(L)}catch(O){}break;default:break}if(y==K){break}}if(!y==K){return}switch(I[y].content){case marknote.constants.TAG_CLOSE_SELF_TERMINATING:C=I[y+1]&&I[y+1].content==marknote.constants.COMMENT_START;if(C){P=y+1;while(C){P=this.parseComment(G,I,P);C=I[P+1]&&I[P+1].content==marknote.constants.COMMENT_START;if(C){P++}}}else{P=y}break;case marknote.constants.TAG_CLOSE:if(I[y+1]){if(I[y+1].isCDATAStart()){var J=I[K+2].content;var B=K+3;if(I[K+2].isCDATAEnd()){J="";B=K+2}var T=new marknote.CDATA(J);z.addContent(T);y=B}else{if(I[y+1].isLiteral){z.setText(I[y+1].getContent())}}}else{P=y}for(K=y+1;K<I.length;K++){var E=I[K].getContent()==marknote.constants.ENDTAG_OPEN&&I[K+1].getContent()==z.getName()?true:false;if(E){P=K;C=I[P+3]&&I[P+3].content==marknote.constants.COMMENT_START;if(C){P=this.parseComment(G,I,P+3)}var D=P==y+1||(I[y+1].isLiteral&&P==y+2)?false:true;if(!D){break}var Q=I[y+1].getPosition();var R=I[P].getPosition();var M=A.slice(Q,R);this.parseElement(M,t,z);break}}if(!E){return}break;default:return}K=P}};marknote.ProcessingInstruction=function(s,t){this.dataType=marknote.constants.DATATYPE_PROCESSINGINSTRUCTION;this.isSw8tXmlContent=false;this.target=s?s:"xml";if(s&&!t){this.data=new Array()}else{if(!t){this.data=[new marknote.Attribute("version","1.0"),new marknote.Attribute("encoding","UTF-8")]}else{this.data=t}}};marknote.ProcessingInstruction.prototype.getData=function(){return this.data};marknote.ProcessingInstruction.prototype.setData=function(s){this.data=s};marknote.ProcessingInstruction.prototype.getTarget=function(){return this.target};marknote.ProcessingInstruction.prototype.setTarget=function(s){this.target=s};marknote.ProcessingInstruction.prototype.setAttribute=function(u){var t=this.getData();if(marknote.Util.dataType(u)==marknote.constants.DATATYPE_ATTRIBUTE){for(var s=0;s<t.length;s++){if(t[s].getName()==u.getName()){t[s].setValue(u.getValue());return}}}};marknote.ProcessingInstruction.prototype.getAttributeValue=function(u){var t=this.getData();for(var s=0;s<t.length;s++){if(t[s].getName()==u){return t[s]}}};marknote.ProcessingInstruction.prototype.setAttributeValue=function(v,t){var u=this.getData();if(v){if(typeof t=="undefined"){t=""}for(var s=0;s<u.length;s++){if(u[s].getName()==v){u[s].setValue(t);return}}u.push(new marknote.Attribute(v,t))}};marknote.ProcessingInstruction.prototype.clone=function(){var s=new marknote.Cloner();return s.cloneProcessingInstruction(this)};marknote.QName=function(s,t){this.dataType=marknote.constants.DATATYPE_QNAME;this.isSw8tXmlContent=false;this.prefix=marknote.Util.nothingToBlank(s);this.localPart=marknote.Util.nothingToBlank(t)};marknote.QName.prototype.getName=function(){var s="";if(marknote.Util.hasValue(this.prefix)){s+=this.prefix+":"}if(marknote.Util.hasValue(this.localPart)){s+=this.localPart}return s};marknote.QName.prototype.setName=function(s){var u=marknote.Util.nothingToBlank(s);var t=u.split(":");if(t.length>1){this.prefix=t[0];this.localPart=t[1]}else{this.prefix="";this.localPart=u}};marknote.QName.prototype.getPrefix=function(){return marknote.Util.nothingToBlank(this.prefix)};marknote.QName.prototype.setPrefix=function(s){this.prefix=marknote.Util.nothingToBlank(s)};marknote.QName.prototype.getLocalPart=function(){return marknote.Util.nothingToBlank(this.localPart)};marknote.QName.prototype.setLocalPart=function(s){this.localPart=marknote.Util.nothingToBlank(s)};marknote.QName.prototype.clone=function(){var s=new marknote.Cloner();return s.clone(this)};marknote.Text=function(s){this.dataType=marknote.constants.DATATYPE_TEXT;this.isSw8tXmlContent=true;this.text=marknote.Util.erefEncode(marknote.Util.nothingToBlank(s))};marknote.Text.prototype.getText=function(s){if(marknote.Util.isEmpty(s)){s=true}var t=marknote.Util.nothingToBlank(this.text);return s?marknote.Util.erefDecode(t):t};marknote.Text.prototype.setText=function(s){this.text=marknote.Util.erefEncode(marknote.Util.nothingToBlank(s))};marknote.Text.prototype.clone=function(){var s=new marknote.Cloner();return s.clone(this)};marknote.Token=function(s,t){this.dataType=marknote.constants.DATATYPE_TOKEN;this.isSwt8XmlContent=false;this.content=typeof(s)=="undefined"?new String():s;this.isLiteral=false;this.position=t?t:0};marknote.Token.prototype.getContent=function(){return this.content};marknote.Token.prototype.setContent=function(s){this.content=s};marknote.Token.prototype.getPosition=function(){return this.position};marknote.Token.prototype.setPosition=function(s){this.position=s};marknote.Token.prototype.hasValue=function(){try{return marknote.Util.hasValue(this.content)}catch(s){return false}};marknote.Token.prototype.isDOCTYPEStart=function(){return this.content==marknote.constants.DOCTYPE_START};marknote.Token.prototype.isPIStart=function(){return this.content==marknote.constants.PI_START};marknote.Token.prototype.isPIEnd=function(){return this.content==marknote.constants.PI_END};marknote.Token.prototype.isSelfTerminating=function(){return this.content==marknote.constants.TAG_CLOSE_SELF_TERMINATING};marknote.Token.prototype.isEndTag=function(){return this.content==marknote.constants.ENDTAG_OPEN};marknote.Token.prototype.isCommentStart=function(){return this.content==marknote.constants.COMMENT_START};marknote.Token.prototype.isCommentEnd=function(){return this.content==marknote.constants.COMMENT_END};marknote.Token.prototype.isAttribute=function(){return this.content==marknote.constants.EQUALS};marknote.Token.prototype.isCDATAStart=function(){return this.content==marknote.constants.CDATA_START};marknote.Token.prototype.isCDATAEnd=function(){return this.content==marknote.constants.CDATA_END};marknote.Token.prototype.isTagOpen=function(){return this.content==marknote.constants.TAG_OPEN};marknote.Token.prototype.isTagClose=function(){return this.content==marknote.constants.TAG_CLOSE};marknote.Token.prototype.isQuote=function(){return this.content==marknote.constants.SQUOTE||this.content==marknote.constants.DQUOTE};marknote.Token.prototype.isQuoted=function(){return this.content.charAt(0)=='"'&&this.content.charAt(this.content.length-1)=='"'};marknote.Token.prototype.getType=function(){if(this.isDOCTYPEStart()){return marknote.constants.TOKENTYPE_DOCTYPE_START}if(this.isPIStart()){return marknote.constants.TOKENTYPE_PI_START}if(this.isPIEnd()){return marknote.constants.TOKENTYPE_PI_END}if(this.isSelfTerminating()){return marknote.constants.TOKENTYPE_SELF_TERMINATING}if(this.isEndTag()){return marknote.constants.TOKENTYPE_ENDTAG_OPEN}if(this.isCommentStart()){return marknote.constants.TOKENTYPE_COMMENT_START}if(this.isCommentEnd()){return marknote.constants.TOKENTYPE_COMMENT_END}if(this.isAttribute()){return marknote.constants.TOKENTYPE_ATTRIBUTE}if(this.isCDATAStart()){return marknote.constants.TOKENTYPE_CDATA_START}if(this.isCDATAEnd()){return marknote.constants.TOKENTYPE_CDATA_END}if(this.isTagOpen()){return marknote.constants.TOKENTYPE_TAG_OPEN}if(this.isTagClose()){return marknote.constants.TOKENTYPE_TAG_CLOSE}if(this.isQuote()){return marknote.constants.TOKENTYPE_QUOTE}if(this.isQuoted()){return marknote.constants.TOKENTYPE_QUOTED}return marknote.constants.TOKENTYPE_NORMAL};marknote.Tokenizer=function(s){this.dataType=marknote.constants.DATATYPE_TOKENIZER;this.isSw8tXmlContent=false;this.setMarkup(s);this.tokens=new Array()};marknote.Tokenizer.prototype.getMarkup=function(){return this.markup};marknote.Tokenizer.prototype.setMarkup=function(s){this.markup=s?s:""};marknote.Tokenizer.prototype.determineTokenType=function(u,t){var s=this.markup.charAt(u);var v=u>0?this.markup.charAt(u-1):null;if(marknote.Util.hasWhitespace(s)){return marknote.constants.TOKENTYPE_WHITESPACE}if(this.markup.slice(u,u+9)==marknote.constants.DOCTYPE_START){return marknote.constants.TOKENTYPE_DOCTYPE_START}if(this.markup.slice(u,u+9)==marknote.constants.CDATA_START){return marknote.constants.TOKENTYPE_CDATA_START}if(this.markup.slice(u,u+4)==marknote.constants.COMMENT_START){return marknote.constants.TOKENTYPE_COMMENT_START}if(this.markup.slice(u,u+3)==marknote.constants.CDATA_END){return marknote.constants.TOKENTYPE_CDATA_END}if(this.markup.slice(u,u+2)==marknote.constants.PI_START){return marknote.constants.TOKENTYPE_PI_START}if(this.markup.slice(u,u+2)==marknote.constants.PI_END){return marknote.constants.TOKENTYPE_PI_END}if(this.markup.slice(u,u+2)==marknote.constants.TAG_CLOSE_SELF_TERMINATING){return marknote.constants.TOKENTYPE_SELF_TERMINATING}if(this.markup.slice(u,u+2)==marknote.constants.ENDTAG_OPEN){return marknote.constants.TOKENTYPE_ENDTAG_OPEN}if(s==marknote.constants.EQUALS&&t){return marknote.constants.TOKENTYPE_ATTRIBUTE}if(s==marknote.constants.TAG_OPEN){return marknote.constants.TOKENTYPE_TAG_OPEN}if(s==marknote.constants.TAG_CLOSE){return marknote.constants.TOKENTYPE_TAG_CLOSE}if(s==marknote.constants.SQUOTE){return marknote.constants.TOKENTYPE_QUOTE}if(s==marknote.constants.DQUOTE){if(v!==null||v!="\\"){return marknote.constants.TOKENTYPE_QUOTE}}if(s==marknote.constants.BRACKET_OPEN){return marknote.constants.TOKENTYPE_BRACKET_OPEN}return marknote.constants.TOKENTYPE_NORMAL};marknote.Tokenizer.prototype.isQuote=function(s){return s==marknote.constants.SQUOTE||s==marknote.constants.DQUOTE};marknote.Tokenizer.prototype.tokenizeTagContent=function(w,u){var t=false;var x,s;for(var v=u+1;v<this.markup.length;v++){if(this.markup.slice(v,v+9)==marknote.constants.CDATA_START){t=true;break}else{if(this.markup.charAt(v)==marknote.constants.TAG_OPEN){break}}}if(t){s=new marknote.Token(marknote.constants.CDATA_START,v);w.push(s);s=new marknote.Token("",v+9);s.isLiteral=true;x=marknote.constants.CDATA_END;for(u=v+9;u<this.markup.length;u++){if(this.markup.slice(u,u+3)==x){w.push(s);s=new marknote.Token(x,u);w.push(s);u+=2;s=new marknote.Token("",u+3);break}else{s.content+=this.markup.charAt(u)}}}else{s=new marknote.Token("",u+1);s.isLiteral=true}return{token:s,c:u}};marknote.Tokenizer.prototype.tokenize=function(){var u=new Array();this.tokens=u;var B=new marknote.Token();var C=false,E=false,A=false;var t,D,F,v;for(var w=0;w<this.markup.length;w++){var s=this.determineTokenType(w,C);switch(s){case marknote.constants.TOKENTYPE_DOCTYPE_START:E=true;if(B.hasValue()){u.push(B)}B=new marknote.Token(marknote.constants.DOCTYPE_START,w);w+=8;break;case marknote.constants.TOKENTYPE_BRACKET_OPEN:if(E){if(B.hasValue()){u.push(B)}B=new marknote.Token(this.markup.charAt(w),w);B.isLiteral=true;t=marknote.constants.BRACKET_CLOSE;for(++w;w<this.markup.length;w++){B.content+=this.markup.charAt(w);if(this.markup.charAt(w)==t){if(B.hasValue()){u.push(B)}B=new marknote.Token("",w+1);break}}}else{B.content+=this.markup.charAt(w)}break;case marknote.constants.TOKENTYPE_PI_START:var x;var z="";if(B.hasValue()){u.push(B)}B=new marknote.Token(marknote.constants.PI_START,w);u.push(B);D=w+2;C=true;for(w=D;w<this.markup.length;w++){x=this.determineTokenType(w,C);if(x==marknote.constants.TOKENTYPE_PI_END){z=this.markup.slice(D,w);if(marknote.Util.isUndefinedNullOrBlank(z)){z="xml"}B=new marknote.Token(z,w);u.push(B);B=new marknote.Token(marknote.constants.PI_END,w);u.push(B);C=false;break}else{if(x==marknote.constants.TOKENTYPE_WHITESPACE){if(z===""){z=this.markup.slice(D,w);if(marknote.Util.isUndefinedNullOrBlank(z)){z="xml"}B=new marknote.Token(z,w);u.push(B)}break}}}B=new marknote.Token("",w);break;case marknote.constants.TOKENTYPE_PI_END:B=new marknote.Token(marknote.constants.PI_END,w);u.push(B);C=false;w+=2;B=new marknote.Token("",w);break;case marknote.constants.TOKENTYPE_WHITESPACE:if(B.isLiteral){B.content+=this.markup.charAt(w);break}for(++w;w<this.markup.length;w++){if(marknote.Util.hasWhitespace(this.markup.charAt(w))){continue}else{if(B.hasValue()){u.push(B)}s=this.determineTokenType(w,C);if(s==marknote.constants.TOKENTYPE_NORMAL){F=this.markup.charAt(w);B=new marknote.Token(F,w)}else{w--;B=new marknote.Token("",w+1)}break}}break;case marknote.constants.TOKENTYPE_SELF_TERMINATING:case marknote.constants.TOKENTYPE_ENDTAG_OPEN:C=false;if(B.hasValue()){u.push(B)}B=new marknote.Token(this.markup.slice(w,w+2),w);if(B.hasValue()){u.push(B)}w++;B=new marknote.Token("",w+1);break;case marknote.constants.TOKENTYPE_TAG_CLOSE:C=false;E=false;if(B.hasValue()){u.push(B)}B=new marknote.Token(marknote.constants.TAG_CLOSE,w);u.push(B);var y=this.tokenizeTagContent(u,w);B=y.token;w=y.c;break;case marknote.constants.TOKENTYPE_ATTRIBUTE:case marknote.constants.TOKENTYPE_TAG_OPEN:if(this.markup.charAt(w)==marknote.constants.TAG_OPEN){C=true}if(B.hasValue()){u.push(B)}B=new marknote.Token(this.markup.charAt(w),w);if(B.hasValue()){u.push(B)}B=new marknote.Token("",w+1);break;case marknote.constants.TOKENTYPE_QUOTE:if(B.hasValue()){u.push(B)}B=new marknote.Token(this.markup.charAt(w),w);B.isLiteral=true;t=this.markup.charAt(w);for(++w;w<this.markup.length;w++){B.content+=this.markup.charAt(w);if(this.markup.charAt(w)==t){if(B.hasValue()){u.push(B)}B=new marknote.Token("",w+1);break}}break;case marknote.constants.TOKENTYPE_COMMENT_START:if(B.hasValue()){u.push(B)}B=new marknote.Token(marknote.constants.COMMENT_START,w);u.push(B);t=marknote.constants.COMMENT_END;D=w+4;for(w=D;w<this.markup.length;w++){if(this.markup.slice(w,w+3)==t){v=this.markup.slice(D,w);B=new marknote.Token(v,D);B.isLiteral=true;u.push(B);B=new marknote.Token(t,w);u.push(B);w=w+2;break}}B=new marknote.Token("",w);break;default:B.content+=this.markup.charAt(w);break}}if(B.hasValue()){u.push(B)}return u};marknote.Util=new Object();marknote.Util.hasWhitespace=function(v){if(typeof v=="undefined"||v===null){return false}var w=v+"";var t=new RegExp(/^\s+$/);for(var u=0;u<w.length;u++){var s=w.charAt(u);if(t.test(s)){return true}}return false};marknote.Util.isUndefinedNullOrBlank=function(s){return !marknote.Util.hasValue(s)};marknote.Util.isEmpty=marknote.Util.isUndefinedNullOrBlank;marknote.Util.nothingToBlank=function(s){return marknote.Util.isEmpty(s)?"":s};marknote.Util.isAllWhitespace=function(v){if(typeof(v)=="undefined"||v===null){return false}var s=v+"";for(var u=0;u<s.length;u++){var t=s.charAt(u);if(!marknote.Util.hasWhitespace(t)){return false}}return true};marknote.Util.hasValue=function(s){if(typeof s=="undefined"||s===null){return false}var t=s+"";return !(t.length===0||marknote.Util.isAllWhitespace(t))};marknote.Util.trim=function(s){var t=s+"";return t.replace(/^\s+|\s+$/g,"")};marknote.Util.leftTrim=function(s){var t=s+"";return t.replace(/^\s+/,"")};marknote.Util.rightTrim=function(s){var t=s+"";return t.replace(/\s+$/,"")};marknote.Util.splitByWhitespace=function(s){if(typeof s=="undefined"||s===null){return s}var t=marknote.Util.trim(s)+"";return t.split(/\s+/)};marknote.Util.removeArrayItem=function(u,t){try{for(var s=0;s<u.length;s++){if(s==t){u.splice(s,1)}}}catch(v){}return u};marknote.Util.dataType=function(s){return typeof s!="undefined"&&s!==null&&s.dataType&&typeof s.dataType=="string"&&s.dataType.length>9&&s.dataType.slice(0,9)=="marknote."?s.dataType:typeof s};marknote.Util.replaceAll=function(u,s,v){var t=u+"";var w=0;var x="";while(t.indexOf(s,w)!=-1){x+=t.substring(w,t.indexOf(s,w));x+=v;w=(t.indexOf(s,w)+s.length)}x+=u.substring(w,u.length);return x};marknote.Util.erefEncode=function(s){var t=s+"";return marknote.Util.erefTransform(t,true)};marknote.Util.erefXMLEncode=function(s){var t=s+"";return marknote.Util.erefTransform(t,true,true)};marknote.Util.erefDecode=function(s){var t=s+"";return marknote.Util.erefTransform(t,false)};marknote.Util.erefXMLDecode=function(s){var t=s+"";return marknote.Util.erefTransform(t,false,true)};marknote.Util.erefTransform=function(w,t,s){var v=s?new marknote.XMLEntityRefs().getRefs():new marknote.EntityRefs().getRefs();var z=new String();z+=w;for(var y=0;y<v.length;y++){var A="&"+v[y].name+";";var B=v[y].character;var u=t?B:A;var x=t?A:B;z=marknote.Util.replaceAll(z,u,x)}return marknote.Util.replaceAll(z,"&quot;",'"')};var q=r.data.file,p=new FileReader();p.onload=function(B){var s=new marknote.Parser(),y,x,I,A=0,F,v,t,E,u=0,G,w=0,z,C,D,H=[];y=s.parse(B.target.result);v=y.getRootElement().getChildElements("trk");for(F=v.length;A<F;A++){I=v[A];E=I.getChildElements("trkseg");for(G=E.length;u<G;u++){x=E[u].getChildElements("trkpt");z=x.length;for(;w<z;w++){C=x[w].getAttribute("lat").getValue();D=x[w].getAttribute("lon").getValue();H.push({latitude:C,longitude:D})}}}self.postMessage(H);self.close()};p.readAsText(q)}try{o=new Blob(["self.addEventListener('message', ",k.valueOf(),", false);"])}catch(m){o=new b();o.append("self.addEventListener('message', ");o.append(k.valueOf());o.append(", false);");o=o.getBlob()}n=new Worker(c(o));n.postMessage({file:l[0]});e.innerText="Reading the file...";n.addEventListener("message",function(q){var p=q.data;if(p&&p.length&&p.length>0){mapController.renderActivityPoints(p);$("input[name=mapEdited]").val(true);g("Race map successfully edited.")}else{g("No point found in your gpx file. Race map not edited.")}},false)}function f(i){i.stopPropagation();i.preventDefault();i.dataTransfer.dropEffect="copy"}})();}

          document.getElementById("bk").href = "javascript:(" + bk.valueOf() + "());";
        </script>

<h3>Testimonials</h3>

<ul>
  <li>Amazing! Works like a sharm! &mdash; <a href="http://support.runkeeper.com/discussions/questions/2878-create-new-race-map-from-activityroute#comment_17209020">Bjornar</a>&nbsp;<ins datetime="2012-08-03">(link broken since last Runkeeper support platform migration)</ins></li>
   <li><ins datetime="2012-08-03">this is phenomenal! I was trying to create a 5.7 mile trail race and it was impossible to get it all correct. Your bookmarklet worked like a champ! Thanks! &mdash; <a href="http://support.runkeeper.com/entries/21704641-editing-a-race-s-map-using-a-gpx-file?page=1#post_21712432">Hollis</a></ins></li>
   <li><ins datetime="2012-09-18">Love the rkrace-bookmarklet! Great for creating race map (!) &mdash; <a href="https://twitter.com/HeatherUrry/status/244604352529043456">@HeatherUrry</a></ins></li>
</ul>

<h3>Support or Contact</h3>

<p>Having trouble? Ping me directly on twitter (<a href="https://twitter.com/jacqueminv">@jacqueminv</a>) or fill an <a href="https://github.com/jacqueminv/rkrace-bookmarklet/issues">issue on github</a>.</p>
      </section>
      <footer>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
  </body>
</html>
