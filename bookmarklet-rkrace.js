javascript:(function() {

    var dropZone = document.createElement("div");
    dropZone.innerText = "Drop the gpx race file here.";
    dropZone.setAttribute("style", "font: bold 0.8em Arial; width:13em; padding: 14.5em 0 1em 0; background: url('data:image/png;base64,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') #EAEAEA no-repeat; position: fixed; top: 1em; left: 1em; z-index: 99999; text-align: center;");
    dropZone.addEventListener('dragover', handleDragOver, false);
    dropZone.addEventListener('drop', handleFileSelect, false);
    document.body.appendChild(dropZone);

    var div = document.createElement('div'),
        ddsupported = ('draggable' in div) || ('ondragstart' in div && 'ondrop' in div),
        objectURLSupported = !!(window.webkitURL.createObjectURL || window.URL.createObjectURL),
        blobBuilderSupported = !!(window.BlobBuilder || window.WebKitBlobBuilder || window.MozBlobBuilder),
        workerSupported = !!window.Worker,
        fileReaderSupported = !!window.FileReader,
        hideDropZone = function(msg){
            dropZone.innerText = msg || "";
            setTimeout(function(){dropZone.parentElement.removeChild(dropZone)}, 2000);
        };

    if (!(ddsupported && objectURLSupported && blobBuilderSupported && workerSupported && fileReaderSupported)) {
        hideDropZone("You need a more recent browser");
        return;
    }

    if (!window.mapController) {
        hideDropZone("Either you're not on RK race edition page, or RK made modifications to the code.");
        return;
    }

    if ( !mapController.model.editable ) {
        hideDropZone("You must edit the race before proceeding.");
        return;
    }

function handleFileSelect(evt) {
    evt.stopPropagation();
    evt.preventDefault();

    var files = evt.dataTransfer.files, bb, worker, bb_builder, blob, urlcreator =  window.webkitURL.createObjectURL || window.URL.createObjectURL;

    if (files.length !== 1 || files[0].size && files[0].size > 5242880) {
      alert("Please give only one file (max size accepted: 5mb)");
      return;
    }

    bb_builder = window.BlobBuilder || window.WebKitBlobBuilder || window.MozBlobBuilder;

    bb = new bb_builder();

    function t(e) {
        /* source: http://code.google.com/p/marknote/ */
        marknote=function(){};marknote.constants={DOCTYPE_START:"<!DOCTYPE",CDATA_START:"<![CDATA[",CDATA_END:"]]>",COMMENT_START:"<!--",COMMENT_END:"-->",TAG_OPEN:"<",TAG_CLOSE:">",TAG_CLOSE_SELF_TERMINATING:"/>",ENDTAG_OPEN:"</",EQUALS:"=",SQUOTE:"'",DQUOTE:'"',PI_START:"<?",PI_END:"?>",BRACKET_OPEN:"[",BRACKET_CLOSE:"]",TOKENTYPE_BRACKET_OPEN:"bracketOpen",TOKENTYPE_TAG_OPEN:"tagOpen",TOKENTYPE_TAG_CLOSE:"tagClose",TOKENTYPE_ENDTAG_OPEN:"endTagOpen",TOKENTYPE_ENDTAG_CLOSE:"endTagClose",TOKENTYPE_SELF_TERMINATING:"closeTagSelfTerminating",TOKENTYPE_WHITESPACE:"whitespace",TOKENTYPE_ATTRIBUTE:"attribute",TOKENTYPE_QUOTE:"quote",TOKENTYPE_QUOTED:"quotedLiteral",TOKENTYPE_NORMAL:"normal",TOKENTYPE_COMMENT_START:"commentStart",TOKENTYPE_COMMENT_END:"commentEnd",TOKENTYPE_CDATA_START:"cdataStart",TOKENTYPE_CDATA_END:"cdataEnd",TOKENTYPE_PI_START:"piStart",TOKENTYPE_PI_END:"piEnd",TOKENTYPE_DOCTYPE_START:"docTypeStart",DATATYPE_ATTRIBUTE:"marknote.Attribute",DATATYPE_CDATA:"marknote.CDATA",DATATYPE_CLONER:"marknote.Cloner",DATATYPE_COMMENT:"marknote.Comment",DATATYPE_DOCTYPE:"marknote.DOCTYPE",DATATYPE_DOCUMENT:"marknote.Document",DATATYPE_ELEMENT:"marknote.Element",DATATYPE_ENTITYREF:"marknote.EntityRef",DATATYPE_XMLENTITYREFS:"marknote.XMLEntityRefs",DATATYPE_ENTITYREFS:"marknote.EntityRefs",DATATYPE_PARSER:"marknote.Parser",DATATYPE_PROCESSINGINSTRUCTION:"marknote.ProcessingInstruction",DATATYPE_QNAME:"marknote.QName",DATATYPE_TEXT:"marknote.Text",DATATYPE_TOKEN:"marknote.Token",DATATYPE_TOKENIZER:"marknote.Tokenizer",DATATYPE_WRITER:"marknote.Writer"};marknote.SJAX=function(){this.req=null;this.status=null;this.statusText=null;this.responseText=null};marknote.Attribute=function(a,b){this.dataType=marknote.constants.DATATYPE_ATTRIBUTE;this.isSw8tXmlContent=false;this.name=a;this.value=marknote.Util.erefEncode(marknote.Util.nothingToBlank(b))};marknote.Attribute.prototype.getName=function(){return this.name};marknote.Attribute.prototype.setName=function(a){this.name=a};marknote.Attribute.prototype.getValue=function(){return marknote.Util.erefDecode(marknote.Util.nothingToBlank(this.value))};marknote.Attribute.prototype.setValue=function(a){this.value=marknote.Util.erefEncode(marknote.Util.nothingToBlank(a))};marknote.Attribute.prototype.clone=function(){return new marknote.Attribute(this.getName(),this.getValue())};marknote.CDATA=function(a){this.dataType=marknote.constants.DATATYPE_CDATA;this.isSw8tXmlContent=true;this.text=marknote.Util.nothingToBlank(a)};marknote.CDATA.prototype.getText=function(){return marknote.Util.nothingToBlank(this.text)};marknote.CDATA.prototype.setText=function(a){this.text=marknote.Util.nothingToBlank(a)};marknote.CDATA.prototype.clone=function(){var a=new marknote.Cloner();return a.clone(this)};marknote.Cloner=function(){this.dataType=marknote.constants.DATATYPE_CLONER;this.isSw8tXmlContent=false};marknote.Cloner.prototype.cloneDocument=function(f){var d=new marknote.Document();var g=f.getProcessingInstructions();var a=f.getRootElement();var c;for(var e=0;e<g.length;e++){c=this.cloneProcessingInstruction(g[e]);d.addProcessingInstruction(c)}var b=this.cloneElement(a);d.setRootElement(b);return d};marknote.Cloner.prototype.cloneProcessingInstruction=function(d){var b=d.getData();var a=d.getTarget().slice(0);var c=this.cloneArray(b);return new marknote.ProcessingInstruction(a,c)};marknote.Cloner.prototype.cloneElement=function(c){var d=new marknote.Element();var a=c.getName().slice(0);var b=this.cloneArray(c.getAttributes());d.setName(a);d.setAttributes(b);if(c.isSelfTerminated){d.isSelfTerminated=true;return d}var e=this.cloneContents(c);d.setContents(e);return d};marknote.Cloner.prototype.cloneContents=function(e){var f=new Array();var b,a;for(var g=0;g<e.getContents().length;g++){var d=e.getContentAt(g);a=marknote.Util.dataType(d);switch(a){case marknote.constants.DATATYPE_ELEMENT:b=this.cloneElement(d);f.push(b);break;default:b=this.clone(d);f.push(b);break}}return f};marknote.Cloner.prototype.clone=function(d){var a=(d.dataType&&d.dataType.indexOf("marknote.")>0)||typeof d=="object";if(!a){return d}var c=new Object();for(var b in d){c[b]=this.clone(d[b])}return c};marknote.Cloner.prototype.cloneArray=function(c){var b=new Array();var d;for(var a=0;a<c.length;a++){d=this.clone(c[a]);b.push(d)}return b};marknote.Comment=function(a){this.dataType=marknote.constants.DATATYPE_COMMENT;this.isSw8tXmlContent=true;this.text=marknote.Util.erefEncode(marknote.Util.nothingToBlank(a))};marknote.Comment.prototype.getText=function(){return marknote.Util.erefDecode(marknote.Util.nothingToBlank(this.text))};marknote.Comment.prototype.setText=function(a){this.text=marknote.Util.erefEncode(marknote.Util.nothingToBlank(a))};marknote.Comment.prototype.clone=function(){var a=new marknote.Cloner();return a.clone(this)};marknote.FPI=function(c,b,e,a,d){this.registration=c;this.organization=b;this.publicTextClass=e;this.publicTextDescription=a;this.publicTextLanguage=d};marknote.FPI.prototype.getRegistration=function(){return this.registration};marknote.FPI.prototype.setRegistration=function(a){this.registration=a};marknote.FPI.prototype.getOrganization=function(){return this.organization};marknote.FPI.prototype.setOrganization=function(a){this.organziation=a};marknote.FPI.prototype.getPublicTextClass=function(){return this.publicTextClass};marknote.FPI.prototype.setPublicTextClass=function(a){this.publicTextClass=a};marknote.FPI.prototype.getPublicTextDescription=function(){return this.publicTextDescription};marknote.FPI.prototype.setPublicTextDescription=function(a){this.publicTextDescription=a};marknote.FPI.prototype.getPublicTextLanguage=function(){return this.publicTextLanguage};marknote.FPI.prototype.setPublicTextLanguage=function(a){this.publicTextLanguage=a};marknote.DOCTYPE=function(h,e,c,a,d){this.dataType=marknote.constants.DATATYPE_DOCTYPE;this.isSw8tXmlContent=false;if(h&&!e){var f=new String(h);var g=new marknote.Parser();var b=g.parseDOCTYPE(f);this.topElement=b.getTopElement();this.availability=b.getAvailability();this.FPI=b.getFPI();this.URL=b.getURL();this.internalSubset=b.getInternalSubset()}else{this.setTopElement(h);this.setAvailability(e);this.setFPI(c);this.setURL(a);this.setInternalSubset(d)}};marknote.DOCTYPE.prototype.getTopElement=function(){return this.topElement};marknote.DOCTYPE.prototype.setTopElement=function(a){this.topElement=a};marknote.DOCTYPE.prototype.getAvailability=function(){return this.availability};marknote.DOCTYPE.prototype.setAvailability=function(a){this.availability=a};marknote.DOCTYPE.prototype.getFPI=function(){return this.FPI};marknote.DOCTYPE.prototype.setFPI=function(a){this.FPI=a};marknote.DOCTYPE.prototype.getURL=function(){return this.URL};marknote.DOCTYPE.prototype.setURL=function(a){var b=marknote.Util.trim(a);if(b===""){this.URL="";return}if(b.charAt(0)!='"'){b='"'+b}if(b.charAt(b.length-1)!='"'){b+='"'}this.URL=b};marknote.DOCTYPE.prototype.getInternalSubset=function(){return this.internalSubset};marknote.DOCTYPE.prototype.setInternalSubset=function(a){this.dataType=marknote.constants.DATATYPE_DOCTYPE;this.internalSubset=a};marknote.Document=function(){this.dataType=marknote.constants.DATATYPE_DOCUMENT;this.isSw8tXmlContent=false;this.processingInstructions=new Array();this.rootElement=new marknote.Element();this.contents=new Array()};marknote.Document.prototype.getProcessingInstructions=function(){return this.processingInstructions};marknote.Document.prototype.setProcessingInstructions=function(a){this.processingInstructions=a};marknote.Document.prototype.addProcessingInstruction=function(a){this.processingInstructions.push(a)};marknote.Document.prototype.removeProcessingInstruction=function(c){for(var b=0;b<this.processingInstructions.length;b++){var a=this.processingInstructions[b].getTarget();if(a==c){marknote.Util.removeArrayItem(this.processingInstructions,b)}}};marknote.Document.prototype.getRootElement=function(){return this.rootElement};marknote.Document.prototype.setRootElement=function(a){if(!(a instanceof marknote.Element)){return}this.rootElement=a};marknote.Document.prototype.getDOCTYPE=function(){return this.DOCTYPE};marknote.Document.prototype.setDOCTYPE=function(a){this.DOCTYPE=a};marknote.Document.prototype.getBaseURI=function(){return this.baseURI};marknote.Document.prototype.setBaseURI=function(a){this.baseURI=a};marknote.Document.prototype.clone=function(){var a=new marknote.Cloner();return a.cloneDocument(this)};marknote.Element=function(a){this.dataType=marknote.constants.DATATYPE_ELEMENT;this.isSw8tXmlContent=true;this.contents=new Array();this.attributes=new Array();this.qname=new marknote.QName();this.isSelfTerminated=false;if(a){if(a instanceof marknote.QName){this.setQName(a)}else{this.setName(a)}}};marknote.Element.prototype.getName=function(){return this.qname.getName()};marknote.Element.prototype.setName=function(a){this.qname.setName(a)};marknote.Element.prototype.getQName=function(){return this.qname};marknote.Element.prototype.setQName=function(a){this.qname=a};marknote.Element.prototype.hasContents=function(){return this.contents&&this.contents.length>0};marknote.Element.prototype.getContents=function(){return this.contents};marknote.Element.prototype.getContentAt=function(a){return this.getContents()[a]};marknote.Element.prototype.addContent=function(a){if(a&&a.isSw8tXmlContent){this.getContents().push(a)}};marknote.Element.prototype.removeContent=function(a){marknote.Util.removeArrayItem(this.contents,a)};marknote.Element.prototype.setContents=function(a){this.contents=a};marknote.Element.prototype.getText=function(d){var e="";if(typeof d=="undefined"){d=true}for(var b=0;b<this.contents.length;b++){var c=this.getContentAt(b);var a=marknote.Util.dataType(c);if(a==marknote.constants.DATATYPE_TEXT){e+=c.getText(d)}else{if(a==marknote.constants.DATATYPE_CDATA){e+=c.getText()}}}return e};marknote.Element.prototype.setText=function(e){var a=new Array();for(var c=0;c<this.contents.length;c++){var d=this.getContentAt(c);var b=marknote.Util.dataType(d);if(b==marknote.constants.DATATYPE_COMMENT){a.push(d)}}this.contents=a;e=e?""+e:"";this.contents.push(new marknote.Text(e))};marknote.Element.prototype.setCDATAText=function(e){var a=new Array();for(var c=0;c<this.contents.length;c++){var d=this.getContentAt(c);var b=marknote.Util.dataType(d);if(b==marknote.constants.DATATYPE_COMMENT){a.push(d)}}this.contents=a;e=e?""+e:"";this.contents.push(new marknote.CDATA(e))};marknote.Element.prototype.removeText=function(){for(var b=this.contents.length-1;b>=0;b--){var c=this.getContentAt(b);var a=marknote.Util.dataType(c);if(a==marknote.constants.DATATYPE_TEXT||a==marknote.constants.DATATYPE_CDATA){marknote.Util.removeArrayItem(this.contents,b)}}};marknote.Element.prototype.getCommentText=function(){var d="";for(var b=0;b<this.contents.length;b++){var c=this.getContentAt(b);var a=marknote.Util.dataType(c);if(a==marknote.constants.DATATYPE_COMMENT){d+=c.getText()}}return d};marknote.Element.prototype.setCommentText=function(a){this.removeComments();a=a?""+a:"";this.addContent(new marknote.Comment(a))};marknote.Element.prototype.removeComments=function(){for(var b=this.contents.length-1;b>=0;b--){var c=this.getContentAt(b);var a=marknote.Util.dataType(c);if(a==marknote.constants.DATATYPE_COMMENT){marknote.Util.removeArrayItem(this.contents,b)}}};marknote.Element.prototype.addChildElement=function(b){var a=marknote.Util.dataType(b);if(!a==marknote.constants.DATATYPE_ELEMENT){return}this.getContents().push(b)};marknote.Element.prototype.removeChildElements=function(f){var e=0;if(!f){e=this.contents.length;this.contents=new Array();return e}var c=f.dataType==marknote.constants.DATATYPE_QNAME?f.getName():f;var d=marknote.Cloner.cloneArray(this.contents);for(var b=d.length-1;b>=0;b--){var a=marknote.Util.dataType(d[b]);if(a!=marknote.constants.DATATYPE_ELEMENT){continue}if(this.clonedContents[b].getName()==c){marknote.Util.removeArrayItem(this.contents,b);e++}}return e};marknote.Element.prototype.getChildElements=function(e){var c=false;var f=new Array();if(e){c=e.dataType==marknote.constants.DATATYPE_QNAME?e.getName():e}for(var b=0;b<this.contents.length;b++){var d=this.contents[b];var a=marknote.Util.dataType(d);if(a!=marknote.constants.DATATYPE_ELEMENT){continue}if(c){if(d.getName()==c){f.push(d)}}else{f.push(d)}}return f};marknote.Element.prototype.getChildElement=function(d){var b=d.dataType==marknote.constants.DATATYPE_QNAME?d.getName():d;if(b){var h=this.getContents();for(var g=0;g<h.length;g++){var f=h[g];var a=marknote.Util.dataType(f);if(a==marknote.constants.DATATYPE_ELEMENT){var e=f.getName();if(e===b){return f}}}}};marknote.Element.prototype.removeChildElement=function(d){var b=d.dataType==marknote.constants.DATATYPE_QNAME?d.getName():d;if(b){var h=this.getContents();for(var g=0;g<h.length;g++){var f=h[g];var a=marknote.Util.dataType(f);if(a==marknote.constants.DATATYPE_ELEMENT){var e=f.getName();if(e===b){marknote.Util.removeArrayItem(this.contents,g);return}}}}};marknote.Element.prototype.getAttributes=function(){return this.attributes};marknote.Element.prototype.setAttributes=function(a){this.attributes=a};marknote.Element.prototype.getAttribute=function(a){for(var b=0;b<this.getAttributes().length;b++){var c=this.getAttributes()[b];if(c.getName()==a){return c}}};marknote.Element.prototype.getAttributeValue=function(a){var b=this.getAttribute(a);return b?b.getValue():""};marknote.Element.prototype.getAttributeAt=function(a){return this.getAttributes()[a]};marknote.Element.prototype.setAttribute=function(a,d){if(marknote.Util.dataType(a)==marknote.constants.DATATYPE_ATTRIBUTE){this.putAttribute(a)}else{for(var b=0;b<this.getAttributes().length;b++){var c=this.getAttributes()[b];if(c.getName()==a){c.setValue(d);return}}this.putAttribute(new marknote.Attribute(a,d))}};marknote.Element.prototype.putAttribute=function(a){if(a&&this.getAttribute(a.getName())){this.removeAttribute(a.getName())}this.getAttributes().push(a)};marknote.Element.prototype.removeAttribute=function(a){var d=new Array();for(var b=0;b<this.getAttributes().length;b++){var c=this.getAttributes()[b];if(c.getName()!=a){d.push(c)}}this.setAttributes(d)};marknote.Element.prototype.removeAllAttributes=function(){this.setAttributes(new Array())};marknote.Element.prototype.clone=function(){var a=new marknote.Cloner();return a.cloneElement(this)};marknote.EntityRef=function(a,b){this.dataType=marknote.constants.DATATYPE_ENTITYREF;this.name=a;this.character=b};marknote.EntityRef.prototype.getName=function(){return this.name};marknote.EntityRef.prototype.setName=function(a){this.name=a};marknote.EntityRef.prototype.getName=function(){return this.name};marknote.EntityRef.prototype.setName=function(a){this.dataType=marknote.constants.DATATYPE_ENTITYREF;this.isSw8tXmlContent=false;this.character=a};marknote.EntityRef.prototype.clone=function(){var a=new marknote.Cloner();return a.clone(this)};marknote.XMLEntityRefs=function(){this.dataType=marknote.constants.DATATYPE_XMLENTITYREFS;this.isSw8tXmlContent=false;this.refs=new Array();this.pushRef("quot",34);this.pushRef("amp",38);this.pushRef("apos",39);this.pushRef("lt",60);this.pushRef("gt",62)};marknote.XMLEntityRefs.prototype.getRefs=function(){return this.refs};marknote.XMLEntityRefs.prototype.pushRef=function(b,a){this.refs.push(new marknote.EntityRef(b,String.fromCharCode(a)))};marknote.EntityRefs=function(){this.dataType=marknote.constants.DATATYPE_ENTITYREFS;this.isSw8tXmlContent=false;this.refs=new Array().concat(new marknote.XMLEntityRefs().getRefs())};marknote.EntityRefs.prototype.getRefs=function(){return this.refs};marknote.Parser=function(){this.dataType=marknote.constants.DATATYPE_PARSER;this.isSw8tXmlContent=false;this.doc=new marknote.Document();this.status=0;this.statusMessage="success"};marknote.Parser.prototype.getDocument=function(){return this.doc};marknote.Parser.prototype.getStatus=function(){return this.status};marknote.Parser.prototype.setStatus=function(a){this.status=a};marknote.Parser.prototype.getStatusMessage=function(){return this.statusMessage};marknote.Parser.prototype.setStatusMessage=function(a){this.statusMessage=a};marknote.Parser.prototype.parseProcessingInstructions=function(k,n){var p=new marknote.Tokenizer(k);var l=p.tokenize();var g=0,c=0;var b=false;var h,j,f,i,a,m,o;for(var q=0;q<l.length;q++){o=l[q].getType();switch(o){case marknote.constants.TOKENTYPE_PI_START:g=l[q].getPosition();j="";f=new Array();b=true;j=l[q+1].getContent();q++;break;case marknote.constants.TOKENTYPE_PI_END:if(b){if(marknote.Util.isUndefinedNullOrBlank(j)){j="xml"}}b=false;c=l[q].getPosition()+2;h=new marknote.ProcessingInstruction(j,f);n.addProcessingInstruction(h);break;case marknote.constants.TOKENTYPE_ATTRIBUTE:if(b){a=l[q-1].getContent();m=l[q+1].getContent();m=m.slice(1,m.length-1);i=new marknote.Attribute(a,m);f.push(i)}q++;break;default:break}}if(c>g){var e=g>0?k.slice(0,g):"";var d=k.slice(c+1);return marknote.Util.trim(e+d)}else{return k}};marknote.Parser.prototype.parseProcessingInstructions=function(k,n){var p=new marknote.Tokenizer(k);var l=p.tokenize();var g=0,c=0;var b=false;var h,j,f,i,a,m,o;for(var q=0;q<l.length;q++){o=l[q].getType();switch(o){case marknote.constants.TOKENTYPE_PI_START:g=l[q].getPosition();j="";f=new Array();b=true;j=l[q+1].getContent();q++;break;case marknote.constants.TOKENTYPE_PI_END:if(b){if(marknote.Util.isUndefinedNullOrBlank(j)){j="xml"}}b=false;c=l[q].getPosition()+2;h=new marknote.ProcessingInstruction(j,f);n.addProcessingInstruction(h);break;case marknote.constants.TOKENTYPE_ATTRIBUTE:if(b){a=l[q-1].getContent();m=l[q+1].getContent();m=m.slice(1,m.length-1);i=new marknote.Attribute(a,m);f.push(i)}q++;break;default:break}}if(c>g){var e=g>0?k.slice(0,g):"";var d=k.slice(c+1);return marknote.Util.trim(e+d)}else{return k}};marknote.Parser.prototype.parseDOCTYPE=function(d,f){var h=new marknote.Tokenizer(d);var e=h.tokenize();var c=new marknote.DOCTYPE();var g,b;try{for(var i=0;i<e.length;i++){g=e[i].getType();switch(g){case marknote.constants.TOKENTYPE_DOCTYPE_START:if(f){f.setDOCTYPE(c)}if(e[++i].isTagClose()){return c}c.setTopElement(e[i].getContent());b=e[++i].getContent().toUpperCase();c.setAvailability(b);if("SYSTEM"==b){if(e[++i].isTagClose()){return c}c.setURL(e[i].getContent())}else{if("PUBLIC"==b){if(e[++i].isTagClose()){return c}c.setFPI(e[i].getContent());if(e[++i].isTagClose()){return c}c.setURL(e[i].getContent());if(e[++i].isTagClose()){return c}c.setInternalSubset(e[i].getContent())}}break;case marknote.constants.TOKENTYPE_TAG_CLOSE:return c;default:break}}}catch(a){window.alert(a)}return c};marknote.Parser.prototype.parse=function(a){this.xhr=null;this.xhrStatus=null;this.xhrStatusText=null;this.xhrResponseText=null;this.doc=new marknote.Document();this.setStatus(0);a=this.parseProcessingInstructions(a,this.doc);this.parseDOCTYPE(a,this.doc);this.parseElement(a,this.doc);return this.doc};marknote.Parser.prototype.parseURL=function(a,d,e){var c=new marknote.SJAX();var b=c.read(a,d,e);this.xhr=c.getRequest();this.xhrStatus=c.getStatus();this.xhrStatusText=c.getStatusText();this.xhrResponseText=c.getResponseText();return b};marknote.Parser.prototype.parseComment=function(a,c,b){var d=c[b+1].content==marknote.constants.COMMENT_START?"":c[b+1].content;var e=new marknote.Comment(d);if(a){a.addContent(e)}b=c[b+1].content==marknote.constants.COMMENT_START?b+1:b+2;return b};marknote.Parser.prototype.parseElement=function(u,x,n){var o=new marknote.Tokenizer(u);var l=o.tokenize();var w=0,e=0;var r=false;for(var j=0;j<l.length;j++){if(l[j].isCommentStart()){j=this.parseComment(n,l,j);continue}for(;j<l.length;j++){if(l[j].isTagOpen()){w=j;break}}if(w!=j){return}var v=new marknote.Element(l[w+1].content);if(!n){x.setRootElement(v)}else{n.addContent(v)}for(j=w+1;j<l.length;j++){switch(l[j].getType()){case marknote.constants.TOKENTYPE_SELF_TERMINATING:v.isSelfTerminated=true;w=j;break;case marknote.constants.TOKENTYPE_TAG_CLOSE:v.isSelfTerminated=false;w=j;break;case marknote.constants.TOKENTYPE_ATTRIBUTE:try{var b=l[j-1].content;var g=l[j+1].content;var m=g.slice(1,g.length-1);var i=new marknote.Attribute(b,m);v.putAttribute(i)}catch(f){}break;default:break}if(w==j){break}}if(!w==j){return}switch(l[w].content){case marknote.constants.TAG_CLOSE_SELF_TERMINATING:r=l[w+1]&&l[w+1].content==marknote.constants.COMMENT_START;if(r){e=w+1;while(r){e=this.parseComment(n,l,e);r=l[e+1]&&l[e+1].content==marknote.constants.COMMENT_START;if(r){e++}}}else{e=w}break;case marknote.constants.TAG_CLOSE:if(l[w+1]){if(l[w+1].isCDATAStart()){var k=l[j+2].content;var s=j+3;if(l[j+2].isCDATAEnd()){k="";s=j+2}var a=new marknote.CDATA(k);v.addContent(a);w=s}else{if(l[w+1].isLiteral){v.setText(l[w+1].getContent())}}}else{e=w}for(j=w+1;j<l.length;j++){var p=l[j].getContent()==marknote.constants.ENDTAG_OPEN&&l[j+1].getContent()==v.getName()?true:false;if(p){e=j;r=l[e+3]&&l[e+3].content==marknote.constants.COMMENT_START;if(r){e=this.parseComment(n,l,e+3)}var q=e==w+1||(l[w+1].isLiteral&&e==w+2)?false:true;if(!q){break}var d=l[w+1].getPosition();var c=l[e].getPosition();var h=u.slice(d,c);this.parseElement(h,x,v);break}}if(!p){return}break;default:return}j=e}};marknote.ProcessingInstruction=function(b,a){this.dataType=marknote.constants.DATATYPE_PROCESSINGINSTRUCTION;this.isSw8tXmlContent=false;this.target=b?b:"xml";if(b&&!a){this.data=new Array()}else{if(!a){this.data=[new marknote.Attribute("version","1.0"),new marknote.Attribute("encoding","UTF-8")]}else{this.data=a}}};marknote.ProcessingInstruction.prototype.getData=function(){return this.data};marknote.ProcessingInstruction.prototype.setData=function(a){this.data=a};marknote.ProcessingInstruction.prototype.getTarget=function(){return this.target};marknote.ProcessingInstruction.prototype.setTarget=function(a){this.target=a};marknote.ProcessingInstruction.prototype.setAttribute=function(c){var d=this.getData();if(marknote.Util.dataType(c)==marknote.constants.DATATYPE_ATTRIBUTE){for(var b=0;b<d.length;b++){if(d[b].getName()==c.getName()){d[b].setValue(c.getValue());return}}}};marknote.ProcessingInstruction.prototype.getAttributeValue=function(c){var d=this.getData();for(var b=0;b<d.length;b++){if(d[b].getName()==c){return d[b]}}};marknote.ProcessingInstruction.prototype.setAttributeValue=function(c,e){var d=this.getData();if(c){if(typeof e=="undefined"){e=""}for(var b=0;b<d.length;b++){if(d[b].getName()==c){d[b].setValue(e);return}}d.push(new marknote.Attribute(c,e))}};marknote.ProcessingInstruction.prototype.clone=function(){var a=new marknote.Cloner();return a.cloneProcessingInstruction(this)};marknote.QName=function(b,a){this.dataType=marknote.constants.DATATYPE_QNAME;this.isSw8tXmlContent=false;this.prefix=marknote.Util.nothingToBlank(b);this.localPart=marknote.Util.nothingToBlank(a)};marknote.QName.prototype.getName=function(){var a="";if(marknote.Util.hasValue(this.prefix)){a+=this.prefix+":"}if(marknote.Util.hasValue(this.localPart)){a+=this.localPart}return a};marknote.QName.prototype.setName=function(b){var c=marknote.Util.nothingToBlank(b);var a=c.split(":");if(a.length>1){this.prefix=a[0];this.localPart=a[1]}else{this.prefix="";this.localPart=c}};marknote.QName.prototype.getPrefix=function(){return marknote.Util.nothingToBlank(this.prefix)};marknote.QName.prototype.setPrefix=function(a){this.prefix=marknote.Util.nothingToBlank(a)};marknote.QName.prototype.getLocalPart=function(){return marknote.Util.nothingToBlank(this.localPart)};marknote.QName.prototype.setLocalPart=function(a){this.localPart=marknote.Util.nothingToBlank(a)};marknote.QName.prototype.clone=function(){var a=new marknote.Cloner();return a.clone(this)};marknote.Text=function(a){this.dataType=marknote.constants.DATATYPE_TEXT;this.isSw8tXmlContent=true;this.text=marknote.Util.erefEncode(marknote.Util.nothingToBlank(a))};marknote.Text.prototype.getText=function(b){if(marknote.Util.isEmpty(b)){b=true}var a=marknote.Util.nothingToBlank(this.text);return b?marknote.Util.erefDecode(a):a};marknote.Text.prototype.setText=function(a){this.text=marknote.Util.erefEncode(marknote.Util.nothingToBlank(a))};marknote.Text.prototype.clone=function(){var a=new marknote.Cloner();return a.clone(this)};marknote.Token=function(b,a){this.dataType=marknote.constants.DATATYPE_TOKEN;this.isSwt8XmlContent=false;this.content=typeof(b)=="undefined"?new String():b;this.isLiteral=false;this.position=a?a:0};marknote.Token.prototype.getContent=function(){return this.content};marknote.Token.prototype.setContent=function(a){this.content=a};marknote.Token.prototype.getPosition=function(){return this.position};marknote.Token.prototype.setPosition=function(a){this.position=a};marknote.Token.prototype.hasValue=function(){try{return marknote.Util.hasValue(this.content)}catch(a){return false}};marknote.Token.prototype.isDOCTYPEStart=function(){return this.content==marknote.constants.DOCTYPE_START};marknote.Token.prototype.isPIStart=function(){return this.content==marknote.constants.PI_START};marknote.Token.prototype.isPIEnd=function(){return this.content==marknote.constants.PI_END};marknote.Token.prototype.isSelfTerminating=function(){return this.content==marknote.constants.TAG_CLOSE_SELF_TERMINATING};marknote.Token.prototype.isEndTag=function(){return this.content==marknote.constants.ENDTAG_OPEN};marknote.Token.prototype.isCommentStart=function(){return this.content==marknote.constants.COMMENT_START};marknote.Token.prototype.isCommentEnd=function(){return this.content==marknote.constants.COMMENT_END};marknote.Token.prototype.isAttribute=function(){return this.content==marknote.constants.EQUALS};marknote.Token.prototype.isCDATAStart=function(){return this.content==marknote.constants.CDATA_START};marknote.Token.prototype.isCDATAEnd=function(){return this.content==marknote.constants.CDATA_END};marknote.Token.prototype.isTagOpen=function(){return this.content==marknote.constants.TAG_OPEN};marknote.Token.prototype.isTagClose=function(){return this.content==marknote.constants.TAG_CLOSE};marknote.Token.prototype.isQuote=function(){return this.content==marknote.constants.SQUOTE||this.content==marknote.constants.DQUOTE};marknote.Token.prototype.isQuoted=function(){return this.content.charAt(0)=='"'&&this.content.charAt(this.content.length-1)=='"'};marknote.Token.prototype.getType=function(){if(this.isDOCTYPEStart()){return marknote.constants.TOKENTYPE_DOCTYPE_START}if(this.isPIStart()){return marknote.constants.TOKENTYPE_PI_START}if(this.isPIEnd()){return marknote.constants.TOKENTYPE_PI_END}if(this.isSelfTerminating()){return marknote.constants.TOKENTYPE_SELF_TERMINATING}if(this.isEndTag()){return marknote.constants.TOKENTYPE_ENDTAG_OPEN}if(this.isCommentStart()){return marknote.constants.TOKENTYPE_COMMENT_START}if(this.isCommentEnd()){return marknote.constants.TOKENTYPE_COMMENT_END}if(this.isAttribute()){return marknote.constants.TOKENTYPE_ATTRIBUTE}if(this.isCDATAStart()){return marknote.constants.TOKENTYPE_CDATA_START}if(this.isCDATAEnd()){return marknote.constants.TOKENTYPE_CDATA_END}if(this.isTagOpen()){return marknote.constants.TOKENTYPE_TAG_OPEN}if(this.isTagClose()){return marknote.constants.TOKENTYPE_TAG_CLOSE}if(this.isQuote()){return marknote.constants.TOKENTYPE_QUOTE}if(this.isQuoted()){return marknote.constants.TOKENTYPE_QUOTED}return marknote.constants.TOKENTYPE_NORMAL};marknote.Tokenizer=function(a){this.dataType=marknote.constants.DATATYPE_TOKENIZER;this.isSw8tXmlContent=false;this.setMarkup(a);this.tokens=new Array()};marknote.Tokenizer.prototype.getMarkup=function(){return this.markup};marknote.Tokenizer.prototype.setMarkup=function(a){this.markup=a?a:""};marknote.Tokenizer.prototype.determineTokenType=function(e,a){var b=this.markup.charAt(e);var d=e>0?this.markup.charAt(e-1):null;if(marknote.Util.hasWhitespace(b)){return marknote.constants.TOKENTYPE_WHITESPACE}if(this.markup.slice(e,e+9)==marknote.constants.DOCTYPE_START){return marknote.constants.TOKENTYPE_DOCTYPE_START}if(this.markup.slice(e,e+9)==marknote.constants.CDATA_START){return marknote.constants.TOKENTYPE_CDATA_START}if(this.markup.slice(e,e+4)==marknote.constants.COMMENT_START){return marknote.constants.TOKENTYPE_COMMENT_START}if(this.markup.slice(e,e+3)==marknote.constants.CDATA_END){return marknote.constants.TOKENTYPE_CDATA_END}if(this.markup.slice(e,e+2)==marknote.constants.PI_START){return marknote.constants.TOKENTYPE_PI_START}if(this.markup.slice(e,e+2)==marknote.constants.PI_END){return marknote.constants.TOKENTYPE_PI_END}if(this.markup.slice(e,e+2)==marknote.constants.TAG_CLOSE_SELF_TERMINATING){return marknote.constants.TOKENTYPE_SELF_TERMINATING}if(this.markup.slice(e,e+2)==marknote.constants.ENDTAG_OPEN){return marknote.constants.TOKENTYPE_ENDTAG_OPEN}if(b==marknote.constants.EQUALS&&a){return marknote.constants.TOKENTYPE_ATTRIBUTE}if(b==marknote.constants.TAG_OPEN){return marknote.constants.TOKENTYPE_TAG_OPEN}if(b==marknote.constants.TAG_CLOSE){return marknote.constants.TOKENTYPE_TAG_CLOSE}if(b==marknote.constants.SQUOTE){return marknote.constants.TOKENTYPE_QUOTE}if(b==marknote.constants.DQUOTE){if(d!==null||d!="\\"){return marknote.constants.TOKENTYPE_QUOTE}}if(b==marknote.constants.BRACKET_OPEN){return marknote.constants.TOKENTYPE_BRACKET_OPEN}return marknote.constants.TOKENTYPE_NORMAL};marknote.Tokenizer.prototype.isQuote=function(a){return a==marknote.constants.SQUOTE||a==marknote.constants.DQUOTE};marknote.Tokenizer.prototype.tokenizeTagContent=function(f,h){var a=false;var e,b;for(var g=h+1;g<this.markup.length;g++){if(this.markup.slice(g,g+9)==marknote.constants.CDATA_START){a=true;break}else{if(this.markup.charAt(g)==marknote.constants.TAG_OPEN){break}}}if(a){b=new marknote.Token(marknote.constants.CDATA_START,g);f.push(b);b=new marknote.Token("",g+9);b.isLiteral=true;e=marknote.constants.CDATA_END;for(h=g+9;h<this.markup.length;h++){if(this.markup.slice(h,h+3)==e){f.push(b);b=new marknote.Token(e,h);f.push(b);h+=2;b=new marknote.Token("",h+3);break}else{b.content+=this.markup.charAt(h)}}}else{b=new marknote.Token("",h+1);b.isLiteral=true}return{token:b,c:h}};marknote.Tokenizer.prototype.tokenize=function(){var m=new Array();this.tokens=m;var f=new marknote.Token();var e=false,b=false,g=false;var n,d,a,l;for(var k=0;k<this.markup.length;k++){var o=this.determineTokenType(k,e);switch(o){case marknote.constants.TOKENTYPE_DOCTYPE_START:b=true;if(f.hasValue()){m.push(f)}f=new marknote.Token(marknote.constants.DOCTYPE_START,k);k+=8;break;case marknote.constants.TOKENTYPE_BRACKET_OPEN:if(b){if(f.hasValue()){m.push(f)}f=new marknote.Token(this.markup.charAt(k),k);f.isLiteral=true;n=marknote.constants.BRACKET_CLOSE;for(++k;k<this.markup.length;k++){f.content+=this.markup.charAt(k);if(this.markup.charAt(k)==n){if(f.hasValue()){m.push(f)}f=new marknote.Token("",k+1);break}}}else{f.content+=this.markup.charAt(k)}break;case marknote.constants.TOKENTYPE_PI_START:var j;var h="";if(f.hasValue()){m.push(f)}f=new marknote.Token(marknote.constants.PI_START,k);m.push(f);d=k+2;e=true;for(k=d;k<this.markup.length;k++){j=this.determineTokenType(k,e);if(j==marknote.constants.TOKENTYPE_PI_END){h=this.markup.slice(d,k);if(marknote.Util.isUndefinedNullOrBlank(h)){h="xml"}f=new marknote.Token(h,k);m.push(f);f=new marknote.Token(marknote.constants.PI_END,k);m.push(f);e=false;break}else{if(j==marknote.constants.TOKENTYPE_WHITESPACE){if(h===""){h=this.markup.slice(d,k);if(marknote.Util.isUndefinedNullOrBlank(h)){h="xml"}f=new marknote.Token(h,k);m.push(f)}break}}}f=new marknote.Token("",k);break;case marknote.constants.TOKENTYPE_PI_END:f=new marknote.Token(marknote.constants.PI_END,k);m.push(f);e=false;k+=2;f=new marknote.Token("",k);break;case marknote.constants.TOKENTYPE_WHITESPACE:if(f.isLiteral){f.content+=this.markup.charAt(k);break}for(++k;k<this.markup.length;k++){if(marknote.Util.hasWhitespace(this.markup.charAt(k))){continue}else{if(f.hasValue()){m.push(f)}o=this.determineTokenType(k,e);if(o==marknote.constants.TOKENTYPE_NORMAL){a=this.markup.charAt(k);f=new marknote.Token(a,k)}else{k--;f=new marknote.Token("",k+1)}break}}break;case marknote.constants.TOKENTYPE_SELF_TERMINATING:case marknote.constants.TOKENTYPE_ENDTAG_OPEN:e=false;if(f.hasValue()){m.push(f)}f=new marknote.Token(this.markup.slice(k,k+2),k);if(f.hasValue()){m.push(f)}k++;f=new marknote.Token("",k+1);break;case marknote.constants.TOKENTYPE_TAG_CLOSE:e=false;b=false;if(f.hasValue()){m.push(f)}f=new marknote.Token(marknote.constants.TAG_CLOSE,k);m.push(f);var i=this.tokenizeTagContent(m,k);f=i.token;k=i.c;break;case marknote.constants.TOKENTYPE_ATTRIBUTE:case marknote.constants.TOKENTYPE_TAG_OPEN:if(this.markup.charAt(k)==marknote.constants.TAG_OPEN){e=true}if(f.hasValue()){m.push(f)}f=new marknote.Token(this.markup.charAt(k),k);if(f.hasValue()){m.push(f)}f=new marknote.Token("",k+1);break;case marknote.constants.TOKENTYPE_QUOTE:if(f.hasValue()){m.push(f)}f=new marknote.Token(this.markup.charAt(k),k);f.isLiteral=true;n=this.markup.charAt(k);for(++k;k<this.markup.length;k++){f.content+=this.markup.charAt(k);if(this.markup.charAt(k)==n){if(f.hasValue()){m.push(f)}f=new marknote.Token("",k+1);break}}break;case marknote.constants.TOKENTYPE_COMMENT_START:if(f.hasValue()){m.push(f)}f=new marknote.Token(marknote.constants.COMMENT_START,k);m.push(f);n=marknote.constants.COMMENT_END;d=k+4;for(k=d;k<this.markup.length;k++){if(this.markup.slice(k,k+3)==n){l=this.markup.slice(d,k);f=new marknote.Token(l,d);f.isLiteral=true;m.push(f);f=new marknote.Token(n,k);m.push(f);k=k+2;break}}f=new marknote.Token("",k);break;default:f.content+=this.markup.charAt(k);break}}if(f.hasValue()){m.push(f)}return m};marknote.Util=new Object();marknote.Util.hasWhitespace=function(e){if(typeof e=="undefined"||e===null){return false}var d=e+"";var a=new RegExp(/^\s+$/);for(var f=0;f<d.length;f++){var b=d.charAt(f);if(a.test(b)){return true}}return false};marknote.Util.isUndefinedNullOrBlank=function(a){return !marknote.Util.hasValue(a)};marknote.Util.isEmpty=marknote.Util.isUndefinedNullOrBlank;marknote.Util.nothingToBlank=function(a){return marknote.Util.isEmpty(a)?"":a};marknote.Util.isAllWhitespace=function(d){if(typeof(d)=="undefined"||d===null){return false}var b=d+"";for(var e=0;e<b.length;e++){var a=b.charAt(e);if(!marknote.Util.hasWhitespace(a)){return false}}return true};marknote.Util.hasValue=function(b){if(typeof b=="undefined"||b===null){return false}var a=b+"";return !(a.length===0||marknote.Util.isAllWhitespace(a))};marknote.Util.trim=function(b){var a=b+"";return a.replace(/^\s+|\s+$/g,"")};marknote.Util.leftTrim=function(b){var a=b+"";return a.replace(/^\s+/,"")};marknote.Util.rightTrim=function(b){var a=b+"";return a.replace(/\s+$/,"")};marknote.Util.splitByWhitespace=function(b){if(typeof b=="undefined"||b===null){return b}var a=marknote.Util.trim(b)+"";return a.split(/\s+/)};marknote.Util.removeArrayItem=function(d,a){try{for(var b=0;b<d.length;b++){if(b==a){d.splice(b,1)}}}catch(c){}return d};marknote.Util.dataType=function(a){return typeof a!="undefined"&&a!==null&&a.dataType&&typeof a.dataType=="string"&&a.dataType.length>9&&a.dataType.slice(0,9)=="marknote."?a.dataType:typeof a};marknote.Util.replaceAll=function(f,b,e){var a=f+"";var d=0;var c="";while(a.indexOf(b,d)!=-1){c+=a.substring(d,a.indexOf(b,d));c+=e;d=(a.indexOf(b,d)+b.length)}c+=f.substring(d,f.length);return c};marknote.Util.erefEncode=function(b){var a=b+"";return marknote.Util.erefTransform(a,true)};marknote.Util.erefXMLEncode=function(b){var a=b+"";return marknote.Util.erefTransform(a,true,true)};marknote.Util.erefDecode=function(b){var a=b+"";return marknote.Util.erefTransform(a,false)};marknote.Util.erefXMLDecode=function(b){var a=b+"";return marknote.Util.erefTransform(a,false,true)};marknote.Util.erefTransform=function(f,j,k){var g=k?new marknote.XMLEntityRefs().getRefs():new marknote.EntityRefs().getRefs();var c=new String();c+=f;for(var d=0;d<g.length;d++){var b="&"+g[d].name+";";var a=g[d].character;var h=j?a:b;var e=j?b:a;c=marknote.Util.replaceAll(c,h,e)}return marknote.Util.replaceAll(c,"&quot;",'"')};
        var file = e.data.file, reader = new FileReader();
        reader.onload = function(e){
            var parser = new marknote.Parser(), xml, trkpt, trk, iTrk = 0, lTrk, trks, trkseg, trksegs, iTrkseg = 0, lTrkseg, i = 0, len, lat, lng, points = [];
            xml = parser.parse(e.target.result);
            trks = xml.getRootElement().getChildElements('trk');
            for ( lTrk = trks.length ; iTrk <  lTrk; iTrk++ ) {
                trk = trks[iTrk];
                trksegs = trk.getChildElements('trkseg');
                for ( lTrkseg = trksegs.length; iTrkseg < lTrkseg; iTrkseg++ ) {
                    trkpt = trksegs[iTrkseg].getChildElements('trkpt');
                    len = trkpt.length;
                    for( ; i < len; i++ ) {
                        lat = trkpt[i].getAttribute('lat').getValue();
                        lng = trkpt[i].getAttribute('lon').getValue();
                        points.push({"latitude": lat, "longitude": lng});
                    }
                }
            }
            self.postMessage(points); self.close();
        }; 
        reader.readAsText(file);
    }

    bb.append("self.addEventListener('message', ");
    bb.append(t.valueOf());
    bb.append(", false);");

    worker = new Worker(urlcreator(bb.getBlob()));
    worker.postMessage({'file': files[0]});
    dropZone.innerText = "Reading the file...";
    worker.addEventListener('message', function(e) {
        var points = e.data;

        if ( points && points.length && points.length > 0 ) {
            mapController.renderActivityPoints(points);
            $("#changesMade").val(true);
            hideDropZone("Race map successfully edited.");
        } else {
            hideDropZone("No point found in your gpx file. Race map not edited.");
        }
    }, false);
  }

  function handleDragOver(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    evt.dataTransfer.dropEffect = 'copy'; 
  }
})();